---
phase: 11-bstock-classic-selector-fix-e2e
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/retailers/sites/bstock-auction.ts
  - src/retailers/sites/bstock.ts
  - tests/e2e/bstock-classic.pw.test.ts
autonomous: true

must_haves:
  truths:
    - "ACE auction page extraction returns a real dollar amount for bid_price (not 0, not null)"
    - "ACE auction page extraction returns a real dollar amount for shipping_fee (not 0, not null)"
    - "BY, JCP, QVC auction pages each return correct bid_price and shipping_fee"
    - "Shipping extraction uses .auction-data-label sibling approach as primary (not #shipping_total_cost or #shipping_fee which may be in unrendered popup)"
    - "Playwright E2E tests pass for all 4 Classic retailers"
  artifacts:
    - path: "src/retailers/sites/bstock-auction.ts"
      provides: "Fixed shipping fee extraction using .auction-data-label sibling"
    - path: "tests/e2e/bstock-classic.pw.test.ts"
      provides: "E2E tests for ACE, BY, JCP, QVC bid_price + shipping_fee"
  key_links:
    - from: "src/retailers/sites/bstock-auction.ts"
      to: "live B-Stock Classic DOM"
      via: ".auction-data-label sibling traversal for shipping"
      pattern: "auction-data-label.*shipping"
    - from: "tests/e2e/bstock-classic.pw.test.ts"
      to: "live auction pages"
      via: "page.evaluate() with selectors"
      pattern: "page\\.evaluate"
---

<objective>
Fix B-Stock Classic bid_price and shipping_fee extraction so ACE, BY, JCP, and QVC return correct values, then verify with Playwright E2E tests against live pages.

Purpose: The current shipping_fee extraction in `bstock-auction.ts` relies on `#shipping_total_cost` which may not render until a shipping address is confirmed. The `.auction-data-label` sibling approach (already in `bstock.ts`) is more reliable and should be the primary strategy in both files.

Output: Fixed extraction code + E2E test file proving all 4 Classic retailers extract bid_price and shipping_fee correctly.
</objective>

<execution_context>
@/home/sean/.claude/get-shit-done/workflows/execute-plan.md
@/home/sean/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/retailers/sites/bstock-auction.ts
@src/retailers/sites/bstock.ts
@tests/e2e/smoke-tl.pw.test.ts
@tests/e2e/extension.setup.ts
@docs/RETAILER-SELECTORS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix shipping_fee extraction in bstock-auction.ts to use .auction-data-label sibling approach</name>
  <files>src/retailers/sites/bstock-auction.ts, src/retailers/sites/bstock.ts</files>
  <action>
In `bstock-auction.ts`, update the `extractShippingFee()` function to use the `.auction-data-label` sibling approach as PRIMARY, with `#shipping_total_cost` demoted to fallback. The verified DOM structure is:

```html
<div class="auction-data-row">
  <div class="auction-data-label">Shipping Cost</div>
  <div class="auction-data-content">
    <div id="shipping_total_cost">
      <span class="price">$397.86</span>
    </div>
  </div>
</div>
```

**New primary approach** (match the pattern already used in `bstock.ts` `extractShippingFeeClassic()`):
1. Query all `.auction-data-label` elements
2. Find label whose text includes "shipping cost" (case-insensitive)
3. Get the parent `.auction-data-row` element
4. Find `.auction-data-content` sibling within parent
5. Check for "free" text → return 0
6. Parse the price text (may be in a `.price` child or directly)

**Keep existing `#shipping_total_cost` and regex fallbacks** as secondary/tertiary strategies.

Similarly, update `extractBidPrice()` in `bstock-auction.ts` to add the `.auction-data-label` sibling approach as an additional primary strategy BEFORE the `#current_bid_amount` fallback. Look for labels containing "current bid" or "opening bid", then get sibling content. The existing `#current_bid_amount` approach should remain as first-try since it's inside the `.auction-data-content` div and works when rendered.

Actually, `#current_bid_amount` is INSIDE the `.auction-data-content` div so it works reliably. Only shipping needs the fix. Keep bid price extraction as-is (it works). Focus the fix on shipping only.

**For `bstock.ts`:** The `extractShippingFeeClassic()` function already uses `.auction-data-label` sibling approach. Verify it also checks for `.price` child element within the content div (the shipping value is inside `<span class="price">$397.86</span>` within `#shipping_total_cost` within `.auction-data-content`). If not, add `.price` child check:
```typescript
// Inside the valueDiv content parsing:
const priceChild = valueDiv.querySelector('.price')
if (priceChild?.textContent) {
  const parsed = parsePrice(priceChild.textContent)
  if (parsed !== null) return parsed
}
```

This ensures `bstock.ts` handles the nested `.price` span within the shipping content div.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
Run `npx vitest run` to verify existing unit tests still pass.
  </verify>
  <done>
`bstock-auction.ts` `extractShippingFee()` uses `.auction-data-label` sibling as primary strategy. `bstock.ts` `extractShippingFeeClassic()` handles nested `.price` child element. Both files compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Playwright E2E tests for all 4 B-Stock Classic retailers</name>
  <files>tests/e2e/bstock-classic.pw.test.ts</files>
  <action>
Create `tests/e2e/bstock-classic.pw.test.ts` following the pattern from `smoke-tl.pw.test.ts`.

**Test structure:**
- One `test.describe('B-Stock Classic E2E')` block
- Shared `beforeAll`/`afterAll` for browser context (use `launchBrowserWithExtension`, `getExtensionId`)
- One test per retailer: ACE, BY, JCP, QVC (4 tests total)
- Each test checks both bid_price AND shipping_fee

**Test URLs** (use live auction URLs — these will expire, so include skip logic):
```typescript
const CLASSIC_URLS = {
  ACE: 'https://bstock.com/acehardware/auction/auction/view/id/2362/',
  BY: 'https://bstock.com/bayer/auction/auction/view/id/1013/',
  JCP: 'https://bstock.com/jcpenney/auction/auction/view/id/11856/',
  QVC: 'https://bstock.com/qvc/auction/auction/view/id/17347/',
}
```

**Each test should:**
1. Navigate to the auction URL with `waitUntil: 'domcontentloaded'`
2. Check if page loaded (not 404, not login redirect). If redirected to login or 404, `test.skip()` with message
3. Use `page.evaluate()` to run the SAME extraction logic that `bstock-auction.ts` uses:
   - For bid_price: `document.querySelector('#current_bid_amount')?.textContent`
   - For shipping_fee: Use the `.auction-data-label` sibling approach:
     ```typescript
     const shipping = await page.evaluate(() => {
       const labels = document.querySelectorAll('.auction-data-label')
       for (const label of labels) {
         if ((label.textContent || '').toLowerCase().includes('shipping cost')) {
           const parent = label.parentElement
           if (parent) {
             const content = parent.querySelector('.auction-data-content')
             if (content) {
               const text = content.textContent || ''
               if (text.toLowerCase().includes('free')) return '$0'
               const priceEl = content.querySelector('.price')
               if (priceEl) return priceEl.textContent?.trim() ?? null
               return text.trim() || null
             }
           }
         }
       }
       return null
     })
     ```
4. If both bid_price and shipping_fee are null AND page shows "closed"/"ended"/"expired" or login form, `test.skip()` gracefully
5. Assert bid_price matches `/\$[\d,]+/`
6. Assert shipping_fee is not null (may be "$0" for free shipping or a dollar amount)

**Important:** BY (Bayer) may require authentication and redirect to login — the test should skip gracefully if redirected.

**Test timeout:** Set `test.setTimeout(30_000)` for each test (network latency to live sites).

Log extracted values with `console.log()` for debugging.
  </action>
  <verify>
Run `npx playwright test tests/e2e/bstock-classic.pw.test.ts --reporter=list` to execute the E2E tests.

Expected outcomes:
- Tests that reach live auction pages: PASS (bid_price and shipping_fee extracted)
- Tests where auctions expired or require login: SKIP (not FAIL)
- No tests should FAIL (either PASS or SKIP)
  </verify>
  <done>
All 4 B-Stock Classic E2E tests either pass (confirming correct extraction) or skip gracefully (expired auction / auth required). No failures. Test file exists at `tests/e2e/bstock-classic.pw.test.ts`.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `npx vitest run` — existing unit tests pass
3. `npx playwright test tests/e2e/bstock-classic.pw.test.ts` — all tests pass or skip gracefully
4. Manual spot-check: For any test that passed, verify the logged bid_price and shipping_fee are realistic dollar amounts (not "$0" for bid, not null for shipping on active auctions)
</verification>

<success_criteria>
1. `bstock-auction.ts` shipping extraction uses `.auction-data-label` sibling as primary approach
2. `bstock.ts` `extractShippingFeeClassic()` handles nested `.price` child element
3. E2E tests exist for ACE, BY, JCP, QVC
4. All E2E tests pass or skip (zero failures)
5. At least one Classic retailer E2E test passes with real bid_price and shipping_fee values
</success_criteria>

<output>
After completion, create `.planning/phases/11-bstock-classic-selector-fix-e2e/11-01-SUMMARY.md`
</output>
