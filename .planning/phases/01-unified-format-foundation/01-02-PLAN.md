---
phase: 01-unified-format-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/popup/popup.ts
  - src/utils/zip-export.ts
autonomous: true

must_haves:
  truths:
    - "Processing a URL produces unified CSV in the output zip"
    - "Auction URL from processed page appears in CSV first row"
    - "Downloaded manifest data is transformed to unified format before zip creation"
    - "Each manifest file becomes a separate unified CSV"
  artifacts:
    - path: "src/popup/popup.ts"
      provides: "Integrated unified transformation in processing pipeline"
      contains: "import.*from.*unified"
    - path: "src/utils/zip-export.ts"
      provides: "Unified format support in zip creation"
      exports: ["createZipFromUnifiedManifests"]
  key_links:
    - from: "src/popup/popup.ts"
      to: "src/unified/transform.ts"
      via: "import and function call"
      pattern: "transformToUnified|generateUnifiedCsv"
    - from: "src/utils/zip-export.ts"
      to: "src/unified/types.ts"
      via: "import UnifiedManifestRow"
      pattern: "import.*Unified.*from"
---

<objective>
Integrate unified format transformation into the extension's download pipeline.

Purpose: Wire the unified transformation (from Plan 01) into popup.ts so that processing URLs produces unified CSV files in the output zip instead of raw files.

Output: Modified popup.ts and zip-export.ts that produce unified format output.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-unified-format-foundation/01-CONTEXT.md
@.planning/phases/01-unified-format-foundation/01-01-SUMMARY.md
@src/popup/popup.ts
@src/utils/zip-export.ts
@src/unified/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unified format support to zip-export</name>
  <files>src/utils/zip-export.ts</files>
  <action>
    Add a new function `createZipFromUnifiedManifests` that:
    1. Takes an array of unified manifest entries:
       ```typescript
       interface UnifiedZipEntry {
         filename: string
         csvContent: string  // Already-generated unified CSV string
         retailer: string
         sourceUrl: string
       }
       ```
    2. Creates a zip file with each entry as a .csv file
    3. Uses the existing JSZip pattern from createZipFromRawFiles
    4. Returns Blob for download

    Also update imports to include unified types from '../unified'.

    Keep existing functions (createZipFromRawFiles, createZipFromManifests) unchanged for backwards compatibility.
  </action>
  <verify>
    `npx tsc --noEmit` passes
    Function signature matches: createZipFromUnifiedManifests(entries: UnifiedZipEntry[]): Promise<Blob>
  </verify>
  <done>
    createZipFromUnifiedManifests function exists and TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire unified transformation into popup processing</name>
  <files>src/popup/popup.ts</files>
  <action>
    Modify handleProcess() to transform raw manifest data to unified format:

    1. Add imports:
       ```typescript
       import { transformToUnified, generateUnifiedCsv } from '../unified'
       import type { AuctionMetadata } from '../unified'
       ```

    2. After downloading raw manifest data (in the processUrlInTab flow):
       - Parse the raw data to ManifestItem[] using existing parseManifestData
       - Create AuctionMetadata object from processUrlInTab result:
         ```typescript
         const metadata: AuctionMetadata = {
           auctionUrl: urlItem.url,
           bidPrice: null,  // Phase 5 will extract this
           shippingFee: null  // Phase 5 will extract this
         }
         ```
       - Transform: `const unifiedRows = transformToUnified(items, metadata)`
       - Generate CSV: `const csvContent = generateUnifiedCsv(unifiedRows, metadata)`

    3. Change from rawEntries to unifiedEntries:
       - Replace `rawEntries: RawZipEntry[]` with `unifiedEntries: UnifiedZipEntry[]`
       - Push unified CSV content instead of raw base64 data:
         ```typescript
         unifiedEntries.push({
           filename: filename.replace(/\.(xlsx|xls)$/, '.csv'),  // Always .csv output
           csvContent,
           retailer,
           sourceUrl: urlItem.url
         })
         ```

    4. Update ZIP creation:
       - Use createZipFromUnifiedManifests(unifiedEntries) instead of createZipFromRawFiles

    5. Keep the existing parseLocalFile flow for uploaded files, but also transform them:
       - After parsing, apply same transformation to unified format
       - Add to unifiedEntries

    Important: The bid_price and shipping_fee will be null in Phase 1 (metadata extraction comes in Phase 5). The columns exist but are empty except for auction_url.
  </action>
  <verify>
    `npx tsc --noEmit` passes
    No TypeScript errors in popup.ts
    Code path shows: raw data -> parse -> transform -> CSV -> zip
  </verify>
  <done>
    popup.ts uses unified transformation pipeline
    Processing produces unified CSV in output zip
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end integration</name>
  <files>src/popup/popup.ts, src/utils/zip-export.ts</files>
  <action>
    Verify the integration is complete:

    1. Check imports are correct in both files
    2. Ensure type consistency:
       - UnifiedZipEntry in zip-export matches what popup.ts creates
       - AuctionMetadata type is used correctly
    3. Verify the transformation pipeline:
       - Raw manifest data is fetched (existing)
       - Data is parsed to ManifestItem[] (existing, via parseManifestData)
       - ManifestItem[] is transformed to UnifiedManifestRow[]
       - UnifiedManifestRow[] is converted to CSV string
       - CSV string goes into zip entry
       - Zip is downloaded

    4. Run TypeScript check: `npx tsc --noEmit`
    5. Build extension: `npm run build`
  </action>
  <verify>
    `npx tsc --noEmit` passes
    `npm run build` succeeds
    No runtime errors in compiled output
  </verify>
  <done>
    Build succeeds with unified format integration
    Extension is ready to test with real manifests (manual verification)
  </done>
</task>

</tasks>

<verification>
Phase-level verification after all tasks complete:
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. `npm run build` - Extension builds successfully
3. Code review: popup.ts imports and uses unified transformation
4. Code review: zip-export.ts has createZipFromUnifiedManifests function
5. Data flow: URL -> raw download -> parse -> transform -> CSV -> zip
</verification>

<success_criteria>
1. Processing a manifest URL produces a unified CSV in the output zip
2. CSV has exactly 7 columns: item_number, product_name, qty, unit_retail, auction_url, bid_price, shipping_fee
3. auction_url is populated with the processed URL
4. bid_price and shipping_fee are empty (Phase 5 will populate these)
5. Each manifest becomes a separate .csv file in the zip
6. TypeScript compiles and extension builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-unified-format-foundation/01-02-SUMMARY.md`
</output>
