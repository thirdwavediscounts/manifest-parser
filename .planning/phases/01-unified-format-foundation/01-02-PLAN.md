---
phase: 01-unified-format-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/popup/popup.ts
  - src/utils/zip-export.ts
autonomous: true

must_haves:
  truths:
    - "Processing a URL produces unified CSV in the output zip"
    - "Auction URL from processed page appears in CSV first row"
    - "Downloaded manifest data is transformed to unified format before zip creation"
    - "Each manifest file becomes a separate unified CSV"
  artifacts:
    - path: "src/popup/popup.ts"
      provides: "Integrated unified transformation in processing pipeline"
      contains: "import.*from.*unified"
    - path: "src/utils/zip-export.ts"
      provides: "Unified format support in zip creation"
      exports: ["createZipFromUnifiedManifests"]
  key_links:
    - from: "src/popup/popup.ts"
      to: "src/unified/transform.ts"
      via: "import and function call"
      pattern: "transformToUnified|generateUnifiedCsv"
    - from: "src/popup/popup.ts"
      to: "chrome.runtime.sendMessage"
      via: "PARSE_FILE message to background worker"
      pattern: "sendMessage.*PARSE_FILE"
    - from: "src/utils/zip-export.ts"
      to: "src/unified/types.ts"
      via: "import UnifiedManifestRow"
      pattern: "import.*Unified.*from"
---

<objective>
Integrate unified format transformation into the extension's download pipeline.

Purpose: Wire the unified transformation (from Plan 01) into popup.ts so that processing URLs produces unified CSV files in the output zip instead of raw files.

Output: Modified popup.ts and zip-export.ts that produce unified format output.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-unified-format-foundation/01-CONTEXT.md
@.planning/phases/01-unified-format-foundation/01-01-SUMMARY.md
@src/popup/popup.ts
@src/utils/zip-export.ts
@src/unified/index.ts
@src/background/service-worker.ts
@src/parsers/base-parser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unified format support to zip-export</name>
  <files>src/utils/zip-export.ts</files>
  <action>
    Add a new function `createZipFromUnifiedManifests` that:
    1. Takes an array of unified manifest entries:
       ```typescript
       interface UnifiedZipEntry {
         filename: string
         csvContent: string  // Already-generated unified CSV string
         retailer: string
         sourceUrl: string
       }
       ```
    2. Creates a zip file with each entry as a .csv file
    3. Uses the existing JSZip pattern from createZipFromRawFiles
    4. Returns Blob for download

    Also update imports to include unified types from '../unified'.

    Keep existing functions (createZipFromRawFiles, createZipFromManifests) unchanged for backwards compatibility.
  </action>
  <verify>
    `npx tsc --noEmit` passes
    Function signature matches: createZipFromUnifiedManifests(entries: UnifiedZipEntry[]): Promise<Blob>
  </verify>
  <done>
    createZipFromUnifiedManifests function exists and TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire unified transformation into popup processing</name>
  <files>src/popup/popup.ts</files>
  <action>
    Modify handleProcess() to transform raw manifest data to unified format.

    CURRENT FLOW (raw files):
    1. processUrlInTab() returns base64 manifestData
    2. base64 is stored directly in rawEntries[]
    3. createZipFromRawFiles() creates zip from raw base64

    NEW FLOW (unified format):
    1. processUrlInTab() returns base64 manifestData
    2. Parse base64 data by sending PARSE_FILE message to background worker
    3. Receive ManifestItem[] from background worker
    4. Transform ManifestItem[] to unified format using transformToUnified()
    5. Generate CSV using generateUnifiedCsv()
    6. Store CSV in unifiedEntries[]
    7. createZipFromUnifiedManifests() creates zip

    Implementation steps:

    1. Add imports at top of popup.ts:
       ```typescript
       import { transformToUnified, generateUnifiedCsv } from '../unified'
       import type { AuctionMetadata } from '../unified'
       ```

    2. Create helper function to parse raw base64 data via background worker:
       ```typescript
       async function parseManifestFromBase64(
         data: string,
         filename: string,
         fileType: 'csv' | 'xlsx' | 'xls'
       ): Promise<ManifestItem[]> {
         const response = await chrome.runtime.sendMessage<ExtensionMessage, ExtensionMessage<ManifestItem[]>>({
           type: 'PARSE_FILE',
           payload: { data, filename, type: fileType },
         })
         if (response?.error) {
           throw new Error(response.error)
         }
         return response?.payload || []
       }
       ```

    3. In handleProcess(), after getting manifestData from processUrlInTab:
       - Create AuctionMetadata from URL:
         ```typescript
         const metadata: AuctionMetadata = {
           auctionUrl: urlItem.url,
           bidPrice: null,  // Phase 5 will extract this
           shippingFee: null  // Phase 5 will extract this
         }
         ```
       - Parse raw data to ManifestItem[]:
         ```typescript
         const items = await parseManifestFromBase64(
           result.manifestData,
           filename,
           result.manifestType
         )
         ```
       - Transform and generate CSV:
         ```typescript
         const unifiedRows = transformToUnified(items, metadata)
         const csvContent = generateUnifiedCsv(unifiedRows, metadata)
         ```

    4. Replace rawEntries array with unifiedEntries:
       ```typescript
       interface UnifiedZipEntry {
         filename: string
         csvContent: string
         retailer: string
         sourceUrl: string
       }
       const unifiedEntries: UnifiedZipEntry[] = []
       ```

       Push entries:
       ```typescript
       unifiedEntries.push({
         filename: filename.replace(/\.(xlsx|xls)$/, '.csv'),
         csvContent,
         retailer,
         sourceUrl: urlItem.url
       })
       ```

    5. Update ZIP creation to use createZipFromUnifiedManifests(unifiedEntries)

    6. Update parseLocalFile flow similarly:
       - After parsing file to ManifestItem[], apply unified transformation
       - Add to unifiedEntries (with sourceUrl: 'local-upload')

    Important: bid_price and shipping_fee will be null in Phase 1. The columns exist but are empty except for auction_url.
  </action>
  <verify>
    `npx tsc --noEmit` passes
    No TypeScript errors in popup.ts
    Code shows: raw base64 -> PARSE_FILE message -> ManifestItem[] -> transformToUnified -> generateUnifiedCsv -> zip
  </verify>
  <done>
    popup.ts uses unified transformation pipeline
    Processing produces unified CSV in output zip
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end integration</name>
  <files>src/popup/popup.ts, src/utils/zip-export.ts</files>
  <action>
    Verify the integration is complete:

    1. Check imports are correct in both files
    2. Ensure type consistency:
       - UnifiedZipEntry in zip-export matches what popup.ts creates
       - AuctionMetadata type is used correctly
    3. Verify the transformation pipeline:
       - Raw manifest data is fetched via processUrlInTab (existing)
       - Data is sent to background worker via PARSE_FILE message
       - Background worker returns ManifestItem[] (using existing parseManifestData)
       - ManifestItem[] is transformed to UnifiedManifestRow[]
       - UnifiedManifestRow[] is converted to CSV string
       - CSV string goes into zip entry
       - Zip is downloaded

    4. Run TypeScript check: `npx tsc --noEmit`
    5. Build extension: `npm run build`
  </action>
  <verify>
    `npx tsc --noEmit` passes
    `npm run build` succeeds
    No runtime errors in compiled output
  </verify>
  <done>
    Build succeeds with unified format integration
    Extension is ready to test with real manifests (manual verification)
  </done>
</task>

</tasks>

<verification>
Phase-level verification after all tasks complete:
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. `npm run build` - Extension builds successfully
3. Code review: popup.ts imports and uses unified transformation
4. Code review: popup.ts sends PARSE_FILE message to background worker
5. Code review: zip-export.ts has createZipFromUnifiedManifests function
6. Data flow: URL -> raw download -> PARSE_FILE -> ManifestItem[] -> transform -> CSV -> zip
</verification>

<success_criteria>
1. Processing a manifest URL produces a unified CSV in the output zip
2. CSV has exactly 7 columns: item_number, product_name, qty, unit_retail, auction_url, bid_price, shipping_fee
3. auction_url is populated with the processed URL
4. bid_price and shipping_fee are empty (Phase 5 will populate these)
5. Each manifest becomes a separate .csv file in the zip
6. TypeScript compiles and extension builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-unified-format-foundation/01-02-SUMMARY.md`
</output>
