---
phase: 01-unified-format-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/unified/types.ts
  - src/unified/transform.ts
  - src/unified/index.ts
autonomous: true

must_haves:
  truths:
    - "Transformation converts ManifestItem[] to UnifiedManifestRow[] with correct field mapping"
    - "CSV output has exactly 7 columns: item_number, product_name, qty, unit_retail, auction_url, bid_price, shipping_fee"
    - "First row contains auction metadata, subsequent rows have empty metadata columns"
    - "Prices appear as raw numbers without currency symbols"
    - "Quantities are whole numbers (rounded/truncated)"
  artifacts:
    - path: "src/unified/types.ts"
      provides: "UnifiedManifestRow and AuctionMetadata interfaces"
      exports: ["UnifiedManifestRow", "AuctionMetadata", "UnifiedManifestOutput"]
    - path: "src/unified/transform.ts"
      provides: "Transformation and CSV generation functions"
      exports: ["transformToUnified", "generateUnifiedCsv"]
    - path: "src/unified/index.ts"
      provides: "Module exports"
      exports: ["UnifiedManifestRow", "AuctionMetadata", "transformToUnified", "generateUnifiedCsv"]
  key_links:
    - from: "src/unified/transform.ts"
      to: "../parsers/types"
      via: "import ManifestItem"
      pattern: "import.*ManifestItem.*from"
---

<objective>
Define the unified CSV output structure and implement transformation logic with TDD.

Purpose: Establish the core data types and transformation functions that convert raw manifest items into a consistent unified format for Retool import.

Output: Working, tested unified format module (types + transformation + CSV generation).
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-unified-format-foundation/01-CONTEXT.md
@src/parsers/types.ts
@src/utils/csv-export.ts
</context>

<feature>
  <name>Unified Format Transformation</name>
  <files>src/unified/types.ts, src/unified/transform.ts, src/unified/index.ts</files>
  <behavior>
    Transform ManifestItem[] + AuctionMetadata into unified CSV format.

    Input ManifestItem:
    - upc: string
    - productName: string
    - unitRetail: number
    - quantity: number

    Input AuctionMetadata:
    - auctionUrl: string
    - bidPrice: number | null
    - shippingFee: number | null

    Output CSV columns (in order):
    - item_number (from upc/identifier)
    - product_name (from productName)
    - qty (from quantity, whole number)
    - unit_retail (from unitRetail, raw number no $)
    - auction_url (first row only, from metadata)
    - bid_price (first row only, from metadata)
    - shipping_fee (first row only, from metadata)

    Cases:
    - Empty items[] + metadata -> CSV with headers only
    - 3 items + metadata -> 4 rows (header + 3 data rows), metadata on row 1 only
    - Item with price 29.99 -> "29.99" (no $, min decimals)
    - Item with price 29.00 -> "29" (no trailing zeros)
    - Item with qty 2.5 -> qty = 3 (rounded)
    - Missing metadata -> empty strings for auction_url, bid_price, shipping_fee
    - Product name with comma -> properly quoted in CSV
  </behavior>
  <implementation>
    1. Create src/unified/types.ts with interfaces
    2. Create src/unified/transform.ts with:
       - transformToUnified(items: ManifestItem[], metadata: AuctionMetadata): UnifiedManifestRow[]
       - generateUnifiedCsv(rows: UnifiedManifestRow[], metadata: AuctionMetadata): string
       - formatPrice(value: number): string (helper - min decimals needed)
    3. Create src/unified/index.ts to export public API
    4. Use UTF-8 encoding with BOM for Excel/Retool compatibility
    5. Quote fields only when needed (commas, quotes, newlines)
  </implementation>
</feature>

<verification>
After TDD cycle completes:
- `npx tsc --noEmit` passes with no errors
- All test cases from <behavior> pass
- Import { transformToUnified, generateUnifiedCsv } from './unified' works
</verification>

<success_criteria>
1. TypeScript compiles without errors
2. transformToUnified correctly maps ManifestItem fields to UnifiedManifestRow fields
3. generateUnifiedCsv produces valid CSV with exactly 7 columns in correct order
4. Metadata appears only on first data row
5. Prices formatted as raw numbers (29.99, not $29.99)
6. Quantities are whole numbers
7. CSV properly escapes fields containing commas/quotes/newlines
</success_criteria>

<output>
After completion, create `.planning/phases/01-unified-format-foundation/01-01-SUMMARY.md`
</output>
