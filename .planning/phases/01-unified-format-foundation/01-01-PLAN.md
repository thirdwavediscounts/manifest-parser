---
phase: 01-unified-format-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/unified/types.ts
  - src/unified/transform.ts
  - src/unified/index.ts
  - src/unified/__tests__/transform.test.ts
autonomous: true

must_haves:
  truths:
    - "Unified CSV can be imported into Retool without transformation"
    - "CSV columns match Retool expected schema (7 columns in specific order)"
    - "Auction metadata (URL, bid, shipping) appears once per manifest"
    - "Price and quantity formats are Retool-compatible (numbers, not currency strings)"
  artifacts:
    - path: "src/unified/types.ts"
      provides: "UnifiedManifestRow and AuctionMetadata interfaces"
      exports: ["UnifiedManifestRow", "AuctionMetadata", "UnifiedManifestOutput"]
    - path: "src/unified/transform.ts"
      provides: "Transformation and CSV generation functions"
      exports: ["transformToUnified", "generateUnifiedCsv"]
    - path: "src/unified/index.ts"
      provides: "Module exports"
      exports: ["UnifiedManifestRow", "AuctionMetadata", "transformToUnified", "generateUnifiedCsv"]
  key_links:
    - from: "src/unified/transform.ts"
      to: "../parsers/types"
      via: "import ManifestItem"
      pattern: "import.*ManifestItem.*from"
---

<objective>
Define the unified CSV output structure and implement transformation logic with TDD.

Purpose: Establish the core data types and transformation functions that convert raw manifest items into a consistent unified format for Retool import.

Output: Working, tested unified format module (types + transformation + CSV generation).
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-unified-format-foundation/01-CONTEXT.md
@src/parsers/types.ts
@src/utils/csv-export.ts
</context>

<feature>
  <name>Unified Format Transformation</name>
  <files>src/unified/types.ts, src/unified/transform.ts, src/unified/index.ts</files>
  <behavior>
    Transform ManifestItem[] + AuctionMetadata into unified CSV format.

    Input ManifestItem:
    - upc: string
    - productName: string
    - unitRetail: number
    - quantity: number

    Input AuctionMetadata:
    - auctionUrl: string
    - bidPrice: number | null
    - shippingFee: number | null

    Output CSV columns (in order):
    - item_number (from upc/identifier)
    - product_name (from productName)
    - qty (from quantity, whole number)
    - unit_retail (from unitRetail, raw number no $)
    - auction_url (first row only, from metadata)
    - bid_price (first row only, from metadata)
    - shipping_fee (first row only, from metadata)

    Cases:
    - Empty items[] + metadata -> CSV with headers only
    - 3 items + metadata -> 4 rows (header + 3 data rows), metadata on row 1 only
    - Item with price 29.99 -> "29.99" (no $, min decimals)
    - Item with price 29.00 -> "29" (no trailing zeros)
    - Item with qty 2.5 -> qty = 3 (rounded)
    - Missing metadata -> empty strings for auction_url, bid_price, shipping_fee
    - Product name with comma -> properly quoted in CSV
  </behavior>
  <implementation>
    1. Create src/unified/types.ts with interfaces
    2. Create src/unified/transform.ts with:
       - transformToUnified(items: ManifestItem[], metadata: AuctionMetadata): UnifiedManifestRow[]
       - generateUnifiedCsv(rows: UnifiedManifestRow[], metadata: AuctionMetadata): string
       - formatPrice(value: number): string (helper - min decimals needed)
    3. Create src/unified/index.ts to export public API
    4. Use UTF-8 encoding with BOM for Excel/Retool compatibility
    5. Quote fields only when needed (commas, quotes, newlines)
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests (RED)</name>
  <files>src/unified/types.ts, src/unified/__tests__/transform.test.ts</files>
  <action>
    Create test file `src/unified/__tests__/transform.test.ts` with tests covering all behavior cases from <behavior> section:

    1. Test transformToUnified:
       - Empty items[] returns empty UnifiedManifestRow[]
       - Items correctly map: upc->item_number, productName->product_name, quantity->qty (rounded), unitRetail->unit_retail
       - Metadata applied only to first row

    2. Test generateUnifiedCsv:
       - Returns header row with exactly 7 columns in order
       - Price formatting: 29.99->"29.99", 29.00->"29"
       - Quantity rounding: 2.5->3
       - CSV escaping: commas in product names are properly quoted
       - Empty metadata results in empty strings for auction columns

    Also create stub src/unified/types.ts with interface definitions only (no implementation).

    Run tests - they MUST fail (functions not implemented yet).
  </action>
  <verify>
    `npm test -- --testPathPattern=transform.test.ts` runs and FAILS
    Tests fail with "function not found" or "undefined" errors (expected)
  </verify>
  <done>
    Failing tests exist that define expected behavior
    Type interfaces defined in types.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement to pass tests (GREEN)</name>
  <files>src/unified/transform.ts, src/unified/index.ts</files>
  <action>
    Implement the transformation functions in src/unified/transform.ts:

    1. transformToUnified(items: ManifestItem[], metadata: AuctionMetadata): UnifiedManifestRow[]
       - Map each ManifestItem to UnifiedManifestRow
       - Round quantities to integers
       - Include metadata on first row only

    2. generateUnifiedCsv(rows: UnifiedManifestRow[], metadata: AuctionMetadata): string
       - Generate CSV header: item_number,product_name,qty,unit_retail,auction_url,bid_price,shipping_fee
       - Format prices without trailing zeros (29.99 stays, 29.00 becomes 29)
       - Properly quote fields containing commas/quotes/newlines
       - Add UTF-8 BOM for Excel compatibility

    3. Create src/unified/index.ts to export public API

    Run tests - they MUST pass.
  </action>
  <verify>
    `npm test -- --testPathPattern=transform.test.ts` passes all tests
    `npx tsc --noEmit` passes with no errors
  </verify>
  <done>
    All tests pass
    TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor and verify (REFACTOR)</name>
  <files>src/unified/transform.ts</files>
  <action>
    Review implementation for:
    - Code clarity and readability
    - Extract helper functions if needed (formatPrice, escapeCSVField)
    - Ensure imports are clean
    - Verify module exports are correct in index.ts

    Only make changes if obvious improvements exist.

    Run tests again to ensure no regressions.
  </action>
  <verify>
    `npm test -- --testPathPattern=transform.test.ts` still passes
    `npx tsc --noEmit` passes
    Code is clean and readable
  </verify>
  <done>
    Implementation is clean and all tests pass
    Module is ready for integration in Plan 01-02
  </done>
</task>

</tasks>

<verification>
After TDD cycle completes:
- `npx tsc --noEmit` passes with no errors
- All test cases from <behavior> pass
- Import { transformToUnified, generateUnifiedCsv } from './unified' works
</verification>

<success_criteria>
1. TypeScript compiles without errors
2. transformToUnified correctly maps ManifestItem fields to UnifiedManifestRow fields
3. generateUnifiedCsv produces valid CSV with exactly 7 columns in correct order
4. Metadata appears only on first data row
5. Prices formatted as raw numbers (29.99, not $29.99)
6. Quantities are whole numbers
7. CSV properly escapes fields containing commas/quotes/newlines
</success_criteria>

<output>
After completion, create `.planning/phases/01-unified-format-foundation/01-01-SUMMARY.md`
</output>
