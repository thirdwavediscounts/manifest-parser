---
phase: 03-amzd-special-handling
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/parsers/amzd-parser.ts
  - tests/parsers/amzd-parser.test.ts
autonomous: true

must_haves:
  truths:
    - "ASIN pattern B0XXXXXXXXX is detected in any cell position"
    - "Right-anchor extraction retrieves values from end positions"
    - "Price calculation multiplies lot price by 4.5 with 2 decimal rounding"
    - "Misalignment detection identifies rows with more cells than headers"
  artifacts:
    - path: "src/parsers/amzd-parser.ts"
      provides: "AMZD-specific parsing functions"
      exports: ["findAsin", "extractRightAnchored", "calculateAmzdUnitRetail", "isAmzdMisaligned", "parseAmzdRow"]
    - path: "tests/parsers/amzd-parser.test.ts"
      provides: "Unit tests for AMZD parser"
      min_lines: 80
  key_links:
    - from: "tests/parsers/amzd-parser.test.ts"
      to: "src/parsers/amzd-parser.ts"
      via: "import"
      pattern: "import.*from.*amzd-parser"
---

<objective>
Create AMZD-specific parsing functions using TDD methodology.

Purpose: Amazon Direct manifests have unique challenges - misaligned columns due to unquoted commas in titles, ASIN-based identification, and a fixed 4.5x price multiplier. These functions provide the building blocks for AMZD parsing.

Output: Tested AMZD parser module with functions for ASIN detection, right-anchor extraction, price calculation, and misalignment detection.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-amzd-special-handling/03-CONTEXT.md
@src/parsers/base-parser.ts
@src/retailers/field-mappings.ts
@csvs/AMZD_161-Units-Pc-Electronics-Wireless-RD.csv
</context>

<feature>
  <name>AMZD Parser Core Functions</name>
  <files>src/parsers/amzd-parser.ts, tests/parsers/amzd-parser.test.ts</files>
  <behavior>
    ASIN detection:
    - findAsin(['Return', 'B083WFQC1C', 'Title']) -> 'B083WFQC1C'
    - findAsin(['No', 'ASIN', 'Here']) -> ''
    - findAsin(['B0', 'Short']) -> '' (must be 10 chars)
    - Pattern: /^B0[A-Z0-9]{8}$/

    Right-anchor extraction:
    - extractRightAnchored(['a', 'b', 'c', 'd'], 1) -> 'd' (last)
    - extractRightAnchored(['a', 'b', 'c', 'd'], 2) -> 'c' (second from end)
    - extractRightAnchored(['a', 'b', 'c', 'd'], 3) -> 'b' (third from end)
    - extractRightAnchored([], 1) -> undefined

    Price calculation:
    - calculateAmzdUnitRetail(100) -> 450 (100 * 4.5)
    - calculateAmzdUnitRetail(188) -> 846 (188 * 4.5)
    - calculateAmzdUnitRetail(17.75) -> 79.88 (rounded to 2 decimals)
    - calculateAmzdUnitRetail(0) -> 0
    - calculateAmzdUnitRetail(NaN) -> 0

    Misalignment detection:
    - isAmzdMisaligned(['a','b','c'], ['H1','H2']) -> true (3 cells > 2 headers)
    - isAmzdMisaligned(['a','b'], ['H1','H2']) -> false (equal)
    - isAmzdMisaligned(['a'], ['H1','H2']) -> false (fewer cells is ok)

    Full row parsing (parseAmzdRow):
    - For well-formed row: Uses header mapping
    - For misaligned row: Uses right-anchor extraction
    - Returns { asin, productName, qty, unitRetail } or null for empty rows
  </behavior>
  <implementation>
    1. Create src/parsers/amzd-parser.ts with:
       - ASIN_PATTERN constant: /^B0[A-Z0-9]{8}$/
       - PRICE_MULTIPLIER constant: 4.5
       - findAsin(cells: unknown[]): string
       - extractRightAnchored<T>(cells: T[], posFromEnd: number): T | undefined
       - calculateAmzdUnitRetail(lotPrice: number): number
       - isAmzdMisaligned(cells: unknown[], headers: string[]): boolean
       - parseAmzdRow(row: Record<string, unknown>, cells: unknown[], headers: string[]): AmzdParsedRow | null

    2. AmzdParsedRow interface:
       { asin: string; productName: string; qty: number; unitRetail: number }

    3. parseAmzdRow logic:
       - If misaligned: Use right-anchor (qty at -3, price at -2)
       - If not misaligned: Use header-based extraction (row['Qty'], row['Lot item price'])
       - For ASIN: Always scan cells with findAsin
       - For productName: Try 'Item Title' || 'Model' || 'Brand' || ''
         NOTE: Per user decision in 03-CONTEXT.md, we use Item Title directly without
         attempting to merge split columns. This simplifies implementation since
         misaligned rows get their title from a single cell anyway.
       - Calculate unitRetail = calculateAmzdUnitRetail(lotPrice)
       - Return null if no ASIN and no productName and no price
  </implementation>
</feature>

<verification>
```bash
# Run AMZD parser tests
npm test -- --testPathPattern="amzd-parser" --coverage

# Verify TypeScript compiles
npx tsc --noEmit

# Check test coverage > 80%
npm test -- --testPathPattern="amzd-parser" --coverage --coverageReporters="text-summary"
```
</verification>

<success_criteria>
- All AMZD parser unit tests pass
- TypeScript compiles without errors
- Test coverage for amzd-parser.ts > 80%
- Functions handle edge cases (empty arrays, NaN, missing values)
</success_criteria>

<output>
After completion, create `.planning/phases/03-amzd-special-handling/03-01-SUMMARY.md`
</output>
