---
phase: 03-amzd-special-handling
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/parsers/base-parser.ts
  - src/retailers/field-mappings.ts
  - tests/integration/retailer-parsing.test.ts
autonomous: true

must_haves:
  truths:
    - "AMZD manifest produces unified output with correct columns"
    - "AMZD ASIN becomes item_number in unified format"
    - "AMZD Item Title becomes product_name in unified format"
    - "AMZD unit_retail is Lot item price * 4.5"
    - "AMZD integration test passes against real CSV file"
  artifacts:
    - path: "src/retailers/field-mappings.ts"
      provides: "AMZD retailer config"
      contains: "amzd"
    - path: "src/parsers/base-parser.ts"
      provides: "AMZD-aware parsing"
      contains: "amzd"
    - path: "tests/integration/retailer-parsing.test.ts"
      provides: "AMZD integration test"
      contains: "AMZD"
  key_links:
    - from: "src/parsers/base-parser.ts"
      to: "src/parsers/amzd-parser.ts"
      via: "import"
      pattern: "import.*from.*amzd-parser"
    - from: "src/retailers/field-mappings.ts"
      to: "RETAILER_CONFIGS"
      via: "Map entry"
      pattern: "\\['amzd'"
---

<objective>
Integrate AMZD parser into the manifest processing pipeline.

Purpose: Wire the AMZD-specific parsing functions into base-parser so that AMZD manifests are processed with the correct column extraction and price calculation.

Output: Working AMZD parsing in the extension, verified by integration test against the sample AMZD CSV.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-amzd-special-handling/03-CONTEXT.md
@.planning/phases/03-amzd-special-handling/03-01-SUMMARY.md
@src/parsers/base-parser.ts
@src/parsers/amzd-parser.ts
@src/retailers/field-mappings.ts
@tests/integration/retailer-parsing.test.ts
@csvs/AMZD_161-Units-Pc-Electronics-Wireless-RD.csv
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AMZD config to RETAILER_CONFIGS</name>
  <files>src/retailers/field-mappings.ts</files>
  <action>
    Add 'amzd' entry to RETAILER_CONFIGS Map in field-mappings.ts:

    ```typescript
    // AMZD (Amazon Direct): Uses ASIN, special price calculation handled in amzd-parser
    [
      'amzd',
      {
        itemNumber: ['ASIN'],
        productName: ['Item Title', 'Model', 'Brand'],
        qty: ['Qty'],
        unitRetail: ['Lot item price'],
      },
    ],
    ```

    Place after existing 'amz' entry for logical grouping.
    Note: The actual price multiplier is applied in amzd-parser.ts, not here.
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    grep -n "amzd" src/retailers/field-mappings.ts
    ```
  </verify>
  <done>RETAILER_CONFIGS contains 'amzd' entry with ASIN, Item Title, Qty, Lot item price mappings</done>
</task>

<task type="auto">
  <name>Task 2: Integrate AMZD parser into base-parser</name>
  <files>src/parsers/base-parser.ts</files>
  <action>
    Update base-parser.ts to use AMZD-specific parsing when site is 'amzd':

    1. Import parseAmzdRow and calculateAmzdUnitRetail from amzd-parser:
       ```typescript
       import { parseAmzdRow, calculateAmzdUnitRetail } from './amzd-parser'
       ```

    2. Add 'amzd' case to getFieldMapping switch (before default):
       ```typescript
       case 'amzd':
         return getAmzdFieldMapping()
       ```

    3. Create getAmzdFieldMapping function that returns the standard mapping but
       the actual parsing override happens in parseManifestData.

    4. In parseManifestData, add special handling for 'amzd' site before the standard loop:
       ```typescript
       if (site === 'amzd') {
         return parseAmzdManifest(rawData, filename)
       }
       ```

    5. Create parseAmzdManifest function:
       - Extracts headers from first row
       - For each row: calls parseAmzdRow with row, Object.values(row), headers
       - Maps result to ManifestItem with calculated unitRetail
       - Filters out null results

    The key difference from standard parsing:
    - ASIN is found via pattern scan, not column position
    - unitRetail = lotPrice * 4.5 (via calculateAmzdUnitRetail)
    - Handles misaligned rows via right-anchor extraction
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    grep -n "amzd\|parseAmzdRow" src/parsers/base-parser.ts
    ```
  </verify>
  <done>base-parser.ts imports amzd-parser and routes 'amzd' site to AMZD-specific parsing</done>
</task>

<task type="auto">
  <name>Task 3: Add AMZD integration test</name>
  <files>tests/integration/retailer-parsing.test.ts</files>
  <action>
    Add integration test for AMZD manifest parsing:

    ```typescript
    describe('AMZD (Amazon Direct)', () => {
      it('should parse AMZD manifest with correct field mappings', async () => {
        const csvPath = path.join(__dirname, '../../csvs/AMZD_161-Units-Pc-Electronics-Wireless-RD.csv')
        const rows = await loadCsv(csvPath)

        const items = parseManifestData(rows, 'amzd', 'amzd-test.csv')

        // Should have items
        expect(items.length).toBeGreaterThan(0)

        // First item should have ASIN as item_number (upc field)
        const firstItem = items[0]
        expect(firstItem.upc).toBe('B083WFQC1C')

        // Product name from Item Title
        expect(firstItem.productName).toContain('GIGABYTE X870E AORUS')

        // unit_retail should be Lot item price * 4.5
        // First row: $188.00 * 4.5 = $846.00
        expect(firstItem.unitRetail).toBe(846)

        // Quantity
        expect(firstItem.quantity).toBe(1)
      })

      it('should calculate unit_retail correctly with 4.5 multiplier', async () => {
        const csvPath = path.join(__dirname, '../../csvs/AMZD_161-Units-Pc-Electronics-Wireless-RD.csv')
        const rows = await loadCsv(csvPath)

        const items = parseManifestData(rows, 'amzd', 'amzd-test.csv')

        // Find Apple Pencil row (6 qty at $17.75)
        // $17.75 * 4.5 = $79.875 -> rounded to $79.88
        const applePencil = items.find(i => i.upc === 'B0CL7J12YK')
        expect(applePencil).toBeDefined()
        expect(applePencil!.unitRetail).toBeCloseTo(79.88, 2)
        expect(applePencil!.quantity).toBe(6)
      })
    })
    ```

    Add this after the existing retailer tests (TL, QVC, etc.)
  </action>
  <verify>
    ```bash
    npm test -- --testPathPattern="retailer-parsing" --testNamePattern="AMZD"
    ```
  </verify>
  <done>AMZD integration tests pass, verifying ASIN extraction, product name mapping, and 4.5x price calculation</done>
</task>

<task type="auto">
  <name>Task 4: Verify all tests pass</name>
  <files>-</files>
  <action>
    Run full test suite to ensure AMZD integration doesn't break existing functionality:

    1. Run all tests: `npm test`
    2. Verify TypeScript compiles: `npx tsc --noEmit`
    3. Verify extension builds: `npm run build`

    Expected: All existing tests continue to pass, new AMZD tests pass.
  </action>
  <verify>
    ```bash
    npm test && npx tsc --noEmit && npm run build
    ```
  </verify>
  <done>All tests pass, TypeScript compiles, extension builds successfully</done>
</task>

</tasks>

<verification>
```bash
# Full verification
npm test && npx tsc --noEmit && npm run build

# AMZD-specific checks
npm test -- --testPathPattern="amzd" --coverage
npm test -- --testPathPattern="retailer-parsing" --testNamePattern="AMZD"

# Verify AMZD in field-mappings
grep -n "amzd" src/retailers/field-mappings.ts

# Verify AMZD integration in base-parser
grep -n "amzd\|parseAmzdRow" src/parsers/base-parser.ts
```
</verification>

<success_criteria>
- AMZD integration tests pass
- All existing retailer tests continue to pass
- TypeScript compiles without errors
- Extension builds successfully
- AMZD manifest processing produces correct unified output:
  - item_number = ASIN (e.g., B083WFQC1C)
  - product_name = Item Title
  - unit_retail = Lot item price * 4.5
  - qty = Qty column value
</success_criteria>

<output>
After completion, create `.planning/phases/03-amzd-special-handling/03-02-SUMMARY.md`
</output>
