---
phase: 12-bstock-nextjs-json-fix-e2e
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - tests/e2e/bstock-nextjs.pw.test.ts
autonomous: true

must_haves:
  truths:
    - "AMZ auction page E2E test extracts bid_price as a positive number from __NEXT_DATA__"
    - "AMZ auction page E2E test extracts shipping_fee as a non-negative number from __NEXT_DATA__ (or null if auth-required)"
    - "ATT, COSTCO, RC, TGT each have E2E tests verifying bid_price and shipping_fee extraction"
    - "All 5 Next.js E2E tests pass or skip gracefully (expired auction, Cloudflare, auth redirect)"
    - "E2E tests use the same JSON path config as the production extraction code"
  artifacts:
    - path: "tests/e2e/bstock-nextjs.pw.test.ts"
      provides: "Playwright E2E tests for all 5 Next.js retailers"
  key_links:
    - from: "tests/e2e/bstock-nextjs.pw.test.ts"
      to: "live B-Stock Next.js pages"
      via: "page.evaluate() extracting __NEXT_DATA__"
      pattern: "__NEXT_DATA__"
    - from: "tests/e2e/bstock-nextjs.pw.test.ts"
      to: "src/retailers/config/nextjs-paths.ts"
      via: "uses same JSON paths for validation"
      pattern: "auction\\.winningBidAmount|selectedQuote\\.totalPrice"
---

<objective>
Create Playwright E2E tests for all 5 Next.js retailers (AMZ, ATT, COSTCO, RC, TGT) verifying bid_price and shipping_fee extraction from live auction pages.

Purpose: E2E tests validate that the JSON path config from plan 12-01 correctly extracts values from real B-Stock pages. This catches regressions if B-Stock changes their `__NEXT_DATA__` structure.

Output: `tests/e2e/bstock-nextjs.pw.test.ts` with passing tests for all 5 retailers.
</objective>

<execution_context>
@/home/sean/.claude/get-shit-done/workflows/execute-plan.md
@/home/sean/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/12-bstock-nextjs-json-fix-e2e/12-01-SUMMARY.md
@src/retailers/config/nextjs-paths.ts
@src/retailers/sites/bstock.ts
@tests/e2e/bstock-classic.pw.test.ts
@tests/e2e/extension.setup.ts
@docs/SELECTORS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Playwright E2E tests for all 5 Next.js retailers</name>
  <files>tests/e2e/bstock-nextjs.pw.test.ts</files>
  <action>
Create `tests/e2e/bstock-nextjs.pw.test.ts` following the pattern from `bstock-classic.pw.test.ts`.

**Test structure:**
- One `test.describe('B-Stock Next.js E2E')` block
- Shared `beforeAll`/`afterAll` for browser context
- One test per retailer: AMZ, ATT, COSTCO, RC, TGT (5 tests total)
- Each test checks both bid_price AND shipping_fee

**Test URLs** — use live B-Stock marketplace listing pages. These are Next.js pages at `bstock.com/buy/listings/details/...`. Find current listing IDs by:
1. Navigate to `https://bstock.com/buy/listings` to find active listings
2. Use example URLs (will expire — include skip logic):

```typescript
const NEXTJS_URLS: Record<string, string> = {
  AMZ: 'https://bstock.com/buy/listings/details/<active-amz-id>',
  ATT: 'https://bstock.com/buy/listings/details/<active-att-id>',
  COSTCO: 'https://bstock.com/buy/listings/details/<active-costco-id>',
  RC: 'https://bstock.com/buy/listings/details/<active-rc-id>',
  TGT: 'https://bstock.com/buy/listings/details/<active-tgt-id>',
}
```

If you cannot find active URLs for all retailers, use whatever is available and mark others with empty string — the test should skip retailers with empty URLs.

**Each test should:**

1. `test.setTimeout(30_000)` for network latency
2. Navigate to the listing URL with `waitUntil: 'domcontentloaded'`
3. Skip if page fails to load, redirects to login, 404, or Cloudflare challenge (same pattern as bstock-classic.pw.test.ts)
4. Extract `__NEXT_DATA__` JSON and navigate to the listing data:

```typescript
const result = await page.evaluate(() => {
  const nextDataEl = document.getElementById('__NEXT_DATA__')
  if (!nextDataEl) return { error: 'no __NEXT_DATA__' }

  try {
    const nextData = JSON.parse(nextDataEl.textContent || '{}')
    const queries = nextData?.props?.pageProps?.dehydratedState?.queries || []
    const listingQuery = queries.find((q: any) =>
      JSON.stringify(q.queryKey).includes('listing')
    )
    if (!listingQuery?.state?.data) return { error: 'no listing data in queries' }

    const data = listingQuery.state.data as Record<string, any>

    // Extract seller name for retailer identification
    const seller = data.seller
    const sellerName = seller?.storefront?.name || seller?.account?.displayName || 'unknown'

    // Extract bid price: auction.winningBidAmount (dollars)
    const auction = data.auction
    let bidPrice: number | null = null
    if (auction && typeof auction.winningBidAmount === 'number' && auction.winningBidAmount > 0) {
      bidPrice = auction.winningBidAmount
    } else if (auction && typeof auction.startPrice === 'number' && auction.startPrice > 0) {
      bidPrice = auction.startPrice
    }

    // Extract shipping fee: selectedQuote.totalPrice (CENTS)
    let shippingFee: number | null = null
    const selectedQuote = data.selectedQuote
    if (selectedQuote && typeof selectedQuote.totalPrice === 'number') {
      shippingFee = Math.round(selectedQuote.totalPrice) / 100  // cents to dollars
    }

    return { sellerName, bidPrice, shippingFee, hasNextData: true }
  } catch (e) {
    return { error: `parse error: ${e}` }
  }
})
```

5. Log extracted values for debugging
6. If `error` field present, skip with message
7. **Assertions:**
   - `bidPrice` should be a positive number (> 0) — if null and auction ended, skip
   - `shippingFee`: may be null (auth-required for shipping quotes) — log but do not fail if null. If present, assert >= 0.
   - Verify `sellerName` matches expected retailer (AMZ → "Amazon", TGT → "Target", etc.)

8. **Shipping auth handling:** The `selectedQuote` field requires authentication. Unauthenticated pages may not have this field, so `shippingFee` being null is acceptable. Log: "shipping_fee null (expected — auth-required for shipping quotes)" and do NOT fail the test. Only fail if shipping is present but invalid (negative or non-numeric).

**Important patterns from bstock-classic.pw.test.ts to replicate:**
- Cloudflare/login/404 detection and `test.skip()`
- `page.close()` in all code paths
- Console logging of extracted values
  </action>
  <verify>
Run `npx playwright test tests/e2e/bstock-nextjs.pw.test.ts --reporter=list` to execute E2E tests.

Expected outcomes:
- Tests that reach live listing pages: PASS (bid_price extracted, shipping_fee either extracted or null due to auth)
- Tests where listings expired or require login: SKIP (not FAIL)
- No tests should FAIL (either PASS or SKIP)
  </verify>
  <done>
All 5 Next.js retailer E2E tests either pass (confirming correct __NEXT_DATA__ extraction) or skip gracefully (expired listing / auth required / Cloudflare). No failures. Test file exists at `tests/e2e/bstock-nextjs.pw.test.ts`.
  </done>
</task>

</tasks>

<verification>
1. `npx playwright test tests/e2e/bstock-nextjs.pw.test.ts --reporter=list` — all tests pass or skip
2. At least one Next.js retailer E2E test passes with a real bid_price value
3. Shipping extraction returns a valid dollar amount when authenticated, or null when not (not 0, not error)
4. No test failures (only pass or skip)
</verification>

<success_criteria>
1. E2E test file exists at `tests/e2e/bstock-nextjs.pw.test.ts`
2. Tests cover all 5 retailers: AMZ, ATT, COSTCO, RC, TGT
3. Each test extracts __NEXT_DATA__ and validates bid_price + shipping_fee
4. All tests pass or skip gracefully (zero failures)
5. At least one Next.js retailer test passes with real extracted values
</success_criteria>

<output>
After completion, create `.planning/phases/12-bstock-nextjs-json-fix-e2e/12-02-SUMMARY.md`
</output>
