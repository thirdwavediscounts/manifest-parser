---
phase: 12-bstock-nextjs-json-fix-e2e
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/retailers/config/nextjs-paths.ts
  - src/retailers/sites/bstock.ts
  - docs/SELECTORS.md
autonomous: true

must_haves:
  truths:
    - "Per-retailer JSON path config exists as a separate file from extraction logic"
    - "Config maps each of AMZ, ATT, COSTCO, RC, TGT to their __NEXT_DATA__ JSON paths for bid_price and shipping_fee"
    - "Config includes metadata per path: last-verified date, unit info (dollars vs cents), field descriptions"
    - "Config supports auth-required flag per field"
    - "bstock.ts extractBidPrice and extractShippingFeeNextJs use config paths instead of hardcoded field names"
    - "Sanity checks applied: is number, non-negative, return null if invalid"
  artifacts:
    - path: "src/retailers/config/nextjs-paths.ts"
      provides: "Per-retailer JSON path mapping with metadata"
      exports: ["NEXTJS_RETAILER_PATHS"]
    - path: "src/retailers/sites/bstock.ts"
      provides: "Config-driven extraction replacing hardcoded paths"
    - path: "docs/SELECTORS.md"
      provides: "Updated documentation with JSON paths per retailer"
  key_links:
    - from: "src/retailers/sites/bstock.ts"
      to: "src/retailers/config/nextjs-paths.ts"
      via: "import NEXTJS_RETAILER_PATHS"
      pattern: "NEXTJS_RETAILER_PATHS"
    - from: "src/retailers/config/nextjs-paths.ts"
      to: "__NEXT_DATA__ JSON structure"
      via: "documented paths per retailer"
      pattern: "auction\\.winningBidAmount|selectedQuote\\.totalPrice"
---

<objective>
Create per-retailer JSON path config and refactor bstock.ts to use config-driven extraction for __NEXT_DATA__ fields.

Purpose: Phase 12 CONTEXT.md requires a separate config file mapping retailer to JSON paths (not inline in extractMetadata). The current code hardcodes paths directly in bstock.ts. This plan creates the config, refactors extraction to use it, and updates SELECTORS.md.

Output: `nextjs-paths.ts` config file, refactored bstock.ts extraction, updated SELECTORS.md.
</objective>

<execution_context>
@/home/sean/.claude/get-shit-done/workflows/execute-plan.md
@/home/sean/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/retailers/sites/bstock.ts
@docs/SELECTORS.md
@.planning/phases/12-bstock-nextjs-json-fix-e2e/12-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create per-retailer JSON path config file</name>
  <files>src/retailers/config/nextjs-paths.ts</files>
  <action>
Create `src/retailers/config/nextjs-paths.ts` with a typed config object mapping each Next.js retailer (AMZ, ATT, COSTCO, RC, TGT) to their JSON extraction paths.

**Config shape:**

```typescript
export interface NextJsFieldConfig {
  path: string           // dot-notation path from listing data root (e.g., "auction.winningBidAmount")
  unit: 'dollars' | 'cents'  // strict unit — no heuristics
  description: string    // human-readable field description
  authRequired: boolean  // if true, extraction returns null when unauthenticated
  lastVerified: string   // ISO date of last live verification
  exampleValue?: number  // example raw value from live inspection
}

export interface RetailerNextJsPaths {
  bidPrice: NextJsFieldConfig
  shippingFee: NextJsFieldConfig
}

export const NEXTJS_RETAILER_PATHS: Record<string, RetailerNextJsPaths> = { ... }
```

**All 5 retailers share the same paths** (verified from SELECTORS.md — AMZ docs say ATT/COSTCO/RC/TGT use "Same as AMZ"):

- `bidPrice`: `auction.winningBidAmount` (dollars, not auth-required)
  - Fallback: `auction.startPrice` (dollars, opening bid if no bids yet)
- `shippingFee`: `selectedQuote.totalPrice` (CENTS — divide by 100, authRequired: true)

Set `lastVerified: '2026-01-29'` for AMZ (directly verified), and `lastVerified: '2026-01-29'` for others (inferred from shared codebase, pending E2E in plan 12-02).

Also export a helper function:

```typescript
/**
 * Resolve a dot-notation path on an object.
 * e.g., resolvePath(data, "auction.winningBidAmount") → data.auction.winningBidAmount
 * Returns undefined if any segment is missing.
 */
export function resolvePath(obj: Record<string, unknown>, path: string): unknown { ... }

/**
 * Extract a numeric value from __NEXT_DATA__ using config.
 * Applies unit conversion and sanity checks.
 * Returns null if path doesn't resolve, value is not a number, or value is negative.
 */
export function extractFieldValue(
  data: Record<string, unknown>,
  config: NextJsFieldConfig
): number | null { ... }
```

`extractFieldValue` must:
1. Use `resolvePath` to get raw value
2. Check `typeof value === 'number'` — if not, return null
3. Check `value >= 0` — if negative, return null
4. If `config.unit === 'cents'`, divide by 100 and round to 2 decimal places
5. Return the final dollar amount

Do NOT log warnings when paths don't resolve (per CONTEXT.md: "return null silently").
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
`src/retailers/config/nextjs-paths.ts` exists with typed config for all 5 retailers, `resolvePath` and `extractFieldValue` helper functions, strict unit conversion (cents/100 for shipping), and sanity checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor bstock.ts to use config-driven extraction and update SELECTORS.md</name>
  <files>src/retailers/sites/bstock.ts, docs/SELECTORS.md</files>
  <action>
**Refactor bstock.ts:**

Since `extractMetadata` runs in ISOLATED world and cannot import modules, the config cannot literally be imported at runtime. Instead:

1. Copy the config data and helper logic INLINE into `extractMetadata`. This is consistent with decision D05-01-02: "All helpers inside extractMetadata() for ISOLATED world."
2. Refactor `extractBidPrice()` and `extractShippingFeeNextJs()` to use the config pattern:
   - Detect the retailer name from seller data (already done in existing code)
   - Look up the retailer's config (inline object matching `NEXTJS_RETAILER_PATHS`)
   - Use `resolvePath` + `extractFieldValue` logic to extract values
   - Keep legacy fallback fields as secondary (existing behavior)
   - Keep DOM fallback as tertiary (existing behavior)

3. The **external config file** (`nextjs-paths.ts`) serves as the source of truth for documentation and future E2E tests. The inline copy in `extractMetadata` mirrors it. Add a comment at the top of the inline config: `// Mirror of src/retailers/config/nextjs-paths.ts — keep in sync`

4. Add bid price fallback: if `auction.winningBidAmount` is 0 or missing, try `auction.startPrice`

5. Apply sanity checks that may be missing:
   - `extractBidPrice`: verify result is a number > 0 before returning
   - `extractShippingFeeNextJs`: verify result is a number >= 0 before returning
   - Both: return null (not 0) for invalid/missing values

**Update SELECTORS.md:**

For each of the 5 Next.js retailers (AMZ, ATT, COSTCO, RC, TGT), ensure the documentation includes:
- The exact JSON paths used (already documented for AMZ; ATT/COSTCO/RC/TGT say "Same as AMZ")
- Add a note in each retailer section: "Config source: `src/retailers/config/nextjs-paths.ts`"
- Update "Last Verified" dates to reflect E2E pending status
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run` — existing unit tests still pass.
  </verify>
  <done>
`bstock.ts` uses config-driven extraction with `resolvePath` + sanity checks for all 5 Next.js retailers. `docs/SELECTORS.md` updated with config source references. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `npx vitest run` — existing unit tests pass
3. `src/retailers/config/nextjs-paths.ts` exists with all 5 retailers
4. `bstock.ts` extractBidPrice/extractShippingFeeNextJs use config pattern with sanity checks
5. SELECTORS.md references config source file for Next.js retailers
</verification>

<success_criteria>
1. Per-retailer JSON path config file exists at `src/retailers/config/nextjs-paths.ts`
2. Config maps AMZ, ATT, COSTCO, RC, TGT with typed path definitions including unit info
3. `bstock.ts` extraction uses config-driven approach with strict unit conversion (cents/100 for shipping)
4. Sanity checks applied: is number, non-negative, null on failure
5. SELECTORS.md updated to reference config file
6. All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-bstock-nextjs-json-fix-e2e/12-01-SUMMARY.md`
</output>
