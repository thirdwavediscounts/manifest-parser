---
phase: 05-auction-metadata-extraction
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/popup/popup.ts
autonomous: true

must_haves:
  truths:
    - "Extracted bid_price appears in unified CSV output on first row"
    - "Extracted shipping_fee appears in unified CSV output on first row"
    - "Extraction failure defaults to 0 in final output (not null)"
    - "Status shows 'Extracting metadata...' during extraction"
  artifacts:
    - path: "src/popup/popup.ts"
      provides: "Integration of metadata extraction with CSV generation"
      contains: "bidPrice: result.bidPrice"
  key_links:
    - from: "src/popup/popup.ts"
      to: "src/retailers/types.ts"
      via: "MetadataResult import usage"
      pattern: "result\\.bidPrice"
    - from: "src/popup/popup.ts"
      to: "src/unified/types.ts"
      via: "AuctionMetadata population"
      pattern: "bidPrice:.*\\?\\?"
---

<objective>
Integrate bid_price and shipping_fee extraction results into the unified CSV output pipeline.

Purpose: Complete the flow from extraction to CSV output so metadata appears in downloaded files
Output: Unified CSV files include actual bid_price and shipping_fee values from auction pages
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auction-metadata-extraction/05-CONTEXT.md
@.planning/phases/05-auction-metadata-extraction/05-RESEARCH.md
@.planning/phases/05-auction-metadata-extraction/05-01-SUMMARY.md
@src/popup/popup.ts
@src/unified/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update processUrlInTab to capture extracted metadata</name>
  <files>src/popup/popup.ts</files>
  <action>
In the `processUrlInTab` function, update the metadata extraction section to capture bidPrice and shippingFee from the result.

Find the section around line 1050-1062 where metadata is extracted:
```typescript
if (metadataResult[0]?.result) {
  const metadata = metadataResult[0].result
  retailer = metadata.retailer
  listingName = metadata.listingName
  auctionEndTime = metadata.auctionEndTime
}
```

Add extraction of bidPrice and shippingFee:
```typescript
// Declare variables before try block (around line 1040)
let bidPrice: number | null = null
let shippingFee: number | null = null

// In the metadata extraction block
if (metadataResult[0]?.result) {
  const metadata = metadataResult[0].result
  retailer = metadata.retailer
  listingName = metadata.listingName
  auctionEndTime = metadata.auctionEndTime
  bidPrice = metadata.bidPrice    // NEW
  shippingFee = metadata.shippingFee  // NEW
}
```

Update the return statement (around line 1121) to include the new values:
```typescript
return { retailer, listingName, auctionEndTime, manifestData, manifestType, bidPrice, shippingFee }
```

Note: The return type of processUrlInTab will need to include bidPrice and shippingFee. Check if there's a type definition to update, or TypeScript will infer it.
  </action>
  <verify>Find "bidPrice = metadata.bidPrice" in popup.ts</verify>
  <done>processUrlInTab extracts and returns bidPrice and shippingFee from metadata</done>
</task>

<task type="auto">
  <name>Task 2: Integrate extracted metadata into AuctionMetadata</name>
  <files>src/popup/popup.ts</files>
  <action>
Find ALL places where `AuctionMetadata` objects are created with `bidPrice: null` and `shippingFee: null`, and update them to use the extracted values.

**Location 1: Tab processing result (around lines 576-582)**
This is where the main URL processing happens. Update to use extracted values:
```typescript
// Before (current)
const metadata: AuctionMetadata = {
  auctionUrl: urlItem.url,
  bidPrice: null,
  shippingFee: null,
}

// After (updated)
const metadata: AuctionMetadata = {
  auctionUrl: urlItem.url,
  bidPrice: result.bidPrice ?? 0,     // Use 0 if null per requirements
  shippingFee: result.shippingFee ?? 0, // Use 0 if null per requirements
}
```

The `?? 0` nullish coalescing converts null (not found) to 0 for the CSV output, per the CONTEXT.md requirement: "bid_price not found: Default to 0".

**Location 2: Direct file URL processing (around lines 619-622)**
Direct file downloads don't go through tab processing, so we can't extract metadata from the page. Keep these as 0:
```typescript
const metadata: AuctionMetadata = {
  auctionUrl: urlItem.url,
  bidPrice: 0,  // No page to extract from
  shippingFee: 0,
}
```

**Location 3: Local file uploads (around lines 664-668)**
Local files have no auction URL or metadata:
```typescript
const metadata: AuctionMetadata = {
  auctionUrl: 'local-upload',
  bidPrice: 0,  // Not applicable for local files
  shippingFee: 0,
}
```
  </action>
  <verify>grep "bidPrice: result.bidPrice" src/popup/popup.ts returns a match</verify>
  <done>AuctionMetadata objects populated with extracted bidPrice and shippingFee (defaulting to 0)</done>
</task>

<task type="auto">
  <name>Task 3: Add status feedback during extraction</name>
  <files>src/popup/popup.ts</files>
  <action>
Add "Extracting metadata..." status text before the metadata extraction call.

Find the metadata extraction section in processUrlInTab (around line 1042-1048):
```typescript
try {
  console.log(`[ManifestParser] Extracting metadata from tab ${tabId}`)
```

The updateProgress function is called in the main processing loop, not in processUrlInTab. Check the caller (around line 545) where `processUrlInTab` is called:

```typescript
updateProgress((processed / totalToProcess) * 100, `Processing ${urlItem.retailer}...`)
const result = await processUrlInTab(urlItem, retailerModule)
```

Update this to show extraction status:
```typescript
updateProgress((processed / totalToProcess) * 100, `Extracting from ${urlItem.retailer}...`)
const result = await processUrlInTab(urlItem, retailerModule)
```

The status text "Extracting from [retailer]..." indicates metadata extraction is happening. Per CONTEXT.md: "Show status text: 'Extracting metadata...' during extraction"
  </action>
  <verify>grep "Extracting" src/popup/popup.ts returns a match for the status update</verify>
  <done>Status bar shows extraction progress during metadata extraction</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `grep -E "bidPrice: result|shippingFee: result" src/popup/popup.ts` shows integration points
3. `grep "Extracting" src/popup/popup.ts` shows status text
4. The flow is complete: extractMetadata() -> processUrlInTab() -> AuctionMetadata -> transformToUnified() -> CSV
</verification>

<success_criteria>
- [ ] processUrlInTab returns bidPrice and shippingFee from extraction
- [ ] AuctionMetadata in tab processing uses extracted bidPrice/shippingFee (defaulting to 0)
- [ ] Status shows "Extracting from [retailer]..." during processing
- [ ] TypeScript compiles without errors
- [ ] Direct file and local upload paths use 0 for bid/shipping (no extraction possible)
</success_criteria>

<output>
After completion, create `.planning/phases/05-auction-metadata-extraction/05-02-SUMMARY.md`
</output>
