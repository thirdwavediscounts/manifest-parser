---
phase: 05-auction-metadata-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/retailers/types.ts
  - src/retailers/sites/bstock.ts
  - src/retailers/sites/bstock-auction.ts
  - src/retailers/sites/techliquidators.ts
  - src/retailers/sites/amazon.ts
autonomous: true

must_haves:
  truths:
    - "extractMetadata() returns bidPrice and shippingFee fields for each retailer"
    - "Price parsing handles currency symbols, commas, and TBD values"
    - "Missing data defaults to null (not 0) in extraction layer"
  artifacts:
    - path: "src/retailers/types.ts"
      provides: "Extended MetadataResult interface"
      contains: "bidPrice: number | null"
    - path: "src/retailers/sites/bstock.ts"
      provides: "B-Stock marketplace bid/shipping extraction"
      contains: "extractBidPrice"
    - path: "src/retailers/sites/bstock-auction.ts"
      provides: "B-Stock auction bid/shipping extraction"
      contains: "extractBidPrice"
    - path: "src/retailers/sites/techliquidators.ts"
      provides: "TechLiquidators bid/shipping extraction"
      contains: "extractBidPrice"
    - path: "src/retailers/sites/amazon.ts"
      provides: "Amazon bid/shipping extraction"
      contains: "extractBidPrice"
  key_links:
    - from: "src/retailers/sites/*.ts"
      to: "src/retailers/types.ts"
      via: "MetadataResult return type"
      pattern: "MetadataResult.*bidPrice"
---

<objective>
Extend MetadataResult interface and implement bid_price/shipping_fee extraction in all retailer extractMetadata() functions.

Purpose: Enable capture of auction pricing metadata from listing pages during tab processing
Output: All 4 retailer modules return bidPrice and shippingFee from extractMetadata()
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auction-metadata-extraction/05-CONTEXT.md
@.planning/phases/05-auction-metadata-extraction/05-RESEARCH.md
@src/retailers/types.ts
@src/retailers/sites/bstock.ts
@src/retailers/sites/bstock-auction.ts
@src/retailers/sites/techliquidators.ts
@src/retailers/sites/amazon.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend MetadataResult interface</name>
  <files>src/retailers/types.ts</files>
  <action>
Add bidPrice and shippingFee fields to the MetadataResult interface:

```typescript
export interface MetadataResult {
  retailer: string
  listingName: string
  auctionEndTime: string | null
  bidPrice: number | null      // NEW: Current bid amount (null if not found or not applicable)
  shippingFee: number | null   // NEW: Shipping cost (null if TBD or not found)
}
```

The null type allows distinguishing "not found" from "0" which is a valid price. The popup.ts will convert null to 0 when needed.
  </action>
  <verify>npx tsc --noEmit shows errors in retailer modules (expected - they need to return the new fields)</verify>
  <done>MetadataResult interface includes bidPrice and shippingFee as number | null</done>
</task>

<task type="auto">
  <name>Task 2: Implement extraction in all retailer modules</name>
  <files>src/retailers/sites/bstock.ts, src/retailers/sites/bstock-auction.ts, src/retailers/sites/techliquidators.ts, src/retailers/sites/amazon.ts</files>
  <action>
Add bidPrice and shippingFee extraction to each retailer's extractMetadata() function.

**CRITICAL**: All helper functions must be defined INSIDE the extractMetadata function body because the function is serialized and executed in the browser tab context (ISOLATED world). No outer scope references allowed.

**Price parsing pattern (include in each module):**
```typescript
function parsePrice(text: string | null): number | null {
  if (!text) return null
  // Remove currency symbols, commas, whitespace
  const cleaned = text.replace(/[$,\s]/g, '').trim()
  // Handle "TBD", "N/A", "Calculated" etc
  if (!/^\d/.test(cleaned)) return null
  const value = parseFloat(cleaned)
  return isNaN(value) ? null : value
}
```

**Selector fallback pattern:**
```typescript
function extractWithFallback(selectors: string[]): string | null {
  for (const selector of selectors) {
    const el = document.querySelector(selector)
    if (el?.textContent?.trim()) {
      return el.textContent.trim()
    }
  }
  return null
}
```

**B-Stock Marketplace (bstock.ts):**
- Try __NEXT_DATA__ first: Look for `currentBid`, `winningBid`, `highBid`, `currentPrice` in the listing data
- Shipping: Look for `shippingCost`, `estimatedShipping`, `freightCost` in __NEXT_DATA__
- DOM fallback selectors for bid: `[data-testid*="bid"]`, `[class*="bid-amount"]`, `[class*="current-bid"]`
- DOM fallback selectors for shipping: `[class*="shipping"]`, `[class*="freight"]`
- Add extractBidPrice() and extractShippingFee() helper functions inside extractMetadata
- Add bidPrice and shippingFee to all return statements (including the specialized retailer handlers like extractCostcoMetadata, extractAmazonMetadata, etc)

**B-Stock Auction (bstock-auction.ts):**
- These are older auction pages without __NEXT_DATA__
- DOM selectors for bid: Look for elements containing text like "Current Bid:", "High Bid:", "Winning Bid:"
- Pattern: Find label, then get adjacent/sibling element with price value
- Shipping: Look for "Shipping:", "Freight:", "Estimated Shipping:" labels
- Add extractBidPrice() and extractShippingFee() helpers inside extractMetadata
- Add bidPrice and shippingFee to the return statement

**TechLiquidators (techliquidators.ts):**
- DOM selectors for bid: Look for "Current Bid", "High Bid" labels on detail pages
- Bid is typically prominent near the product image/title area
- Shipping: Look for "Shipping:", "Freight:", "Estimated Shipping:" in the listing details
- Add extractBidPrice() and extractShippingFee() helpers inside extractMetadata
- Add bidPrice and shippingFee to the return statement

**Amazon Direct (amazon.ts):**
- AMZD is fixed-price, NOT an auction, so bidPrice should return null
- Shipping: Look in delivery/shipping section, common selectors: `#delivery-message`, `[data-csa-c-content-id*="shipping"]`
- If shipping shows "FREE Shipping" -> return 0
- If shipping has a price -> parse it
- Add extractShippingFee() helper inside extractMetadata (no extractBidPrice needed, just return null)
- Add bidPrice: null and shippingFee to return statement

**Return statement updates:**
Ensure ALL return paths in each extractMetadata function include the new fields:
```typescript
return {
  retailer,
  listingName,
  auctionEndTime,
  bidPrice: extractBidPrice(),    // or null for AMZD
  shippingFee: extractShippingFee()
}
```

For the specialized handlers in bstock.ts (extractCostcoMetadata, extractAmazonMetadata, extractTargetMetadata, extractAttMetadata, extractRoyalCloseoutsMetadata), you need to:
1. Accept bidPrice and shippingFee as parameters from the outer extractMetadata scope
2. Include them in the return objects

Pattern:
```typescript
// At top of extractMetadata after parsing __NEXT_DATA__
const bidPrice = extractBidPrice()
const shippingFee = extractShippingFee()

// Pass to specialized handlers
if (sellerName?.toLowerCase().includes('costco')) {
  const costcoResult = extractCostcoMetadata(lotTitle, endTimeUtc)
  return { ...costcoResult, bidPrice, shippingFee }
}
```
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>All 4 retailer modules compile and return bidPrice/shippingFee from extractMetadata()</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. Grep shows bidPrice/shippingFee in all 4 retailer files:
   - `grep -l "bidPrice" src/retailers/sites/*.ts` returns all 4 files
3. MetadataResult interface includes both new fields
</verification>

<success_criteria>
- [ ] MetadataResult interface extended with bidPrice: number | null and shippingFee: number | null
- [ ] bstock.ts extractMetadata returns bidPrice and shippingFee
- [ ] bstock-auction.ts extractMetadata returns bidPrice and shippingFee
- [ ] techliquidators.ts extractMetadata returns bidPrice and shippingFee
- [ ] amazon.ts extractMetadata returns bidPrice (null for fixed-price) and shippingFee
- [ ] TypeScript compiles without errors
- [ ] All specialized handlers (Costco, Amazon, Target, ATT, RC) include bidPrice/shippingFee in returns
</success_criteria>

<output>
After completion, create `.planning/phases/05-auction-metadata-extraction/05-01-SUMMARY.md`
</output>
