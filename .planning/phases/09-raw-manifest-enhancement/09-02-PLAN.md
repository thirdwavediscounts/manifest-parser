---
phase: 09-raw-manifest-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/utils/zip-export.ts
  - src/popup/popup.ts
autonomous: true

must_haves:
  truths:
    - "Raw CSV downloads include auction_url, bid_price, shipping_fee as last 3 columns"
    - "Raw XLSX downloads are converted to CSV with metadata columns"
    - "Tab-processed manifests have extracted bid/shipping values in metadata columns"
    - "Direct file URLs and local uploads have 0 values for bid/shipping"
  artifacts:
    - path: "src/utils/zip-export.ts"
      provides: "Updated createZipFromRawFiles"
      exports: ["createZipFromRawFiles", "RawZipEntry"]
    - path: "src/popup/popup.ts"
      provides: "Metadata passing to raw entries"
      contains: "bidPrice:"
  key_links:
    - from: "src/utils/zip-export.ts"
      to: "src/utils/raw-metadata.ts"
      via: "appendMetadataToManifest import"
      pattern: "import.*appendMetadataToManifest.*from.*raw-metadata"
    - from: "src/popup/popup.ts"
      to: "src/utils/zip-export.ts"
      via: "RawZipEntry with metadata"
      pattern: "auctionUrl:.*bidPrice:.*shippingFee:"
---

<objective>
Integrate appendMetadataToManifest into the raw file download pipeline.

Purpose: Wire the metadata appending function through the existing infrastructure so raw downloads include auction metadata.
Output: Raw file downloads (both tab-processed and direct URLs) include the 3 metadata columns.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-raw-manifest-enhancement/09-CONTEXT.md
@.planning/phases/09-raw-manifest-enhancement/09-01-SUMMARY.md
@src/utils/zip-export.ts
@src/popup/popup.ts
@src/utils/raw-metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend RawZipEntry and update createZipFromRawFiles</name>
  <files>src/utils/zip-export.ts</files>
  <action>
    1. Add metadata fields to RawZipEntry interface:
       ```typescript
       export interface RawZipEntry {
         filename: string
         data: string // base64 encoded
         retailer: string
         sourceUrl: string
         fileType: 'csv' | 'xlsx' | 'xls'
         // New metadata fields
         auctionUrl: string
         bidPrice: number
         shippingFee: number
       }
       ```

    2. Import appendMetadataToManifest from './raw-metadata'

    3. Update createZipFromRawFiles to:
       - Call appendMetadataToManifest with entry.data, entry.fileType, and metadata object
       - The function now returns CSV string (not base64)
       - Convert to Uint8Array using TextEncoder
       - All files become .csv regardless of original format
       - Update filename extension handling (always .csv)

    4. Update sanitizeRawFilename to always use .csv extension (remove fileType parameter logic)
  </action>
  <verify>
    ```bash
    # TypeScript check
    npx tsc --noEmit

    # Verify import exists
    grep -n "appendMetadataToManifest" src/utils/zip-export.ts
    ```
  </verify>
  <done>
    - RawZipEntry has auctionUrl, bidPrice, shippingFee fields
    - createZipFromRawFiles calls appendMetadataToManifest
    - All raw files output as CSV format
  </done>
</task>

<task type="auto">
  <name>Task 2: Update popup.ts to pass metadata to raw entries</name>
  <files>src/popup/popup.ts</files>
  <action>
    1. In handleProcess() where rawEntries.push() is called for tab-processed URLs (~line 612-620):
       - Add auctionUrl: urlItem.url
       - Add bidPrice: result.bidPrice ?? 0
       - Add shippingFee: result.shippingFee ?? 0

    2. In handleProcess() where rawEntries.push() is called for direct file URLs (~line 686-694):
       - Add auctionUrl: urlItem.url
       - Add bidPrice: 0
       - Add shippingFee: 0

    3. In handleProcess() where rawEntries.push() is called for uploaded files (~line 761-769):
       - Add auctionUrl: 'local-upload'
       - Add bidPrice: 0
       - Add shippingFee: 0

    All locations need the 3 new fields since RawZipEntry now requires them.
  </action>
  <verify>
    ```bash
    # TypeScript check (will fail if any rawEntries.push missing required fields)
    npx tsc --noEmit

    # Verify metadata fields added to all rawEntries locations
    grep -n "auctionUrl:" src/popup/popup.ts | wc -l
    # Should show 3 occurrences

    grep -n "bidPrice:" src/popup/popup.ts | wc -l
    # Should show at least 6 (3 for raw entries + 3 for unified metadata)
    ```
  </verify>
  <done>
    - All rawEntries.push() calls include auctionUrl, bidPrice, shippingFee
    - Tab-processed URLs use extracted metadata (result.bidPrice/shippingFee)
    - Direct URLs and uploads use default 0 values
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full build and raw mode behavior</name>
  <files>-</files>
  <action>
    Run full build to ensure everything compiles and bundling succeeds.

    1. Run build command
    2. Check for any TypeScript errors
    3. Verify bundle size is reasonable
  </action>
  <verify>
    ```bash
    # Full build
    npm run build

    # Verify no TypeScript errors
    npx tsc --noEmit
    ```
  </verify>
  <done>
    - npm run build succeeds
    - No TypeScript errors
    - Extension ready for testing
  </done>
</task>

</tasks>

<verification>
```bash
# All tasks verification
npm run build
npx tsc --noEmit

# Verify key integrations
grep -n "appendMetadataToManifest" src/utils/zip-export.ts
grep -n "auctionUrl:" src/popup/popup.ts
```
</verification>

<success_criteria>
- Full build passes (npm run build)
- TypeScript compiles without errors
- RawZipEntry interface includes metadata fields
- createZipFromRawFiles uses appendMetadataToManifest
- popup.ts passes metadata to all rawEntries locations
- All raw files become CSV format with 3 appended metadata columns
</success_criteria>

<output>
After completion, create `.planning/phases/09-raw-manifest-enhancement/09-02-SUMMARY.md`
</output>
