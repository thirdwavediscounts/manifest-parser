---
phase: 09-raw-manifest-enhancement
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/utils/raw-metadata.ts
  - src/utils/raw-metadata.test.ts
autonomous: true

must_haves:
  truths:
    - "appendMetadataToManifest returns CSV with auction_url, bid_price, shipping_fee columns appended"
    - "First data row contains metadata values, subsequent rows have empty strings"
    - "XLSX input is converted to CSV output"
    - "Output includes UTF-8 BOM for Excel compatibility"
  artifacts:
    - path: "src/utils/raw-metadata.ts"
      provides: "Metadata appending function"
      exports: ["appendMetadataToManifest"]
    - path: "src/utils/raw-metadata.test.ts"
      provides: "TDD tests"
      min_lines: 50
  key_links:
    - from: "src/utils/raw-metadata.ts"
      to: "src/unified/types.ts"
      via: "AuctionMetadata import"
      pattern: "import.*AuctionMetadata.*from.*unified"
---

<objective>
Create appendMetadataToManifest function using TDD methodology.

Purpose: Transform raw manifest data by appending auction metadata columns while preserving all original data.
Output: Tested function that takes base64 manifest data and returns CSV string with metadata columns appended.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-raw-manifest-enhancement/09-CONTEXT.md
@src/unified/types.ts
@src/unified/transform.ts
</context>

<feature>
  <name>appendMetadataToManifest</name>
  <files>src/utils/raw-metadata.ts, src/utils/raw-metadata.test.ts</files>
  <behavior>
    Transforms raw manifest data by appending 3 metadata columns.

    Function signature:
    ```typescript
    function appendMetadataToManifest(
      data: string,           // base64 encoded CSV or XLSX
      fileType: 'csv' | 'xlsx' | 'xls',
      metadata: AuctionMetadata
    ): string                 // CSV string with UTF-8 BOM
    ```

    Behavior cases:
    - CSV input "A,B\n1,2\n3,4" + metadata(url="x", bid=10, ship=5)
      => "\ufeffA,B,auction_url,bid_price,shipping_fee\n1,2,x,10,5\n3,4,,,"
    - XLSX input with same data => same CSV output
    - Empty metadata values (bid=0, ship=0) => "0" in output, not empty
    - Proper CSV escaping for URLs containing commas

    Key decisions from CONTEXT.md:
    - Always output CSV regardless of input format
    - Include UTF-8 BOM (\ufeff) for Excel/Retool compatibility
    - Preserve original column order and names exactly
    - Metadata values on first data row only
    - Use ?? 0 for null values (defensive)
  </behavior>
  <implementation>
    1. Decode base64 to string/binary
    2. Parse CSV or XLSX (use xlsx library for XLSX)
    3. Extract headers and data rows
    4. Append 3 new header columns: auction_url, bid_price, shipping_fee
    5. For first data row: append metadata values
    6. For subsequent rows: append empty strings
    7. Re-encode as CSV with proper escaping
    8. Prepend UTF-8 BOM
    9. Return CSV string

    Use existing xlsx library (already in project for XLSX parsing).
    Reuse escapeCSVField pattern from src/unified/transform.ts.
  </implementation>
</feature>

<verification>
```bash
# Run tests
npm test -- src/utils/raw-metadata.test.ts

# TypeScript check
npx tsc --noEmit
```
</verification>

<success_criteria>
- All tests pass: CSV input, XLSX input, metadata placement, escaping
- Function exported from src/utils/raw-metadata.ts
- TypeScript compiles without errors
- UTF-8 BOM present in output (starts with \ufeff)
</success_criteria>

<output>
After completion, create `.planning/phases/09-raw-manifest-enhancement/09-01-SUMMARY.md`
</output>
