---
phase: 13-amzd-csv-metadata-fix-e2e
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - src/retailers/sites/amazon.ts
  - tests/e2e/amzd.pw.test.ts
autonomous: true

must_haves:
  truths:
    - "AMZD shipping_fee extraction returns a real value from Amazon product page (not 0)"
    - "AMZD bid_price correctly returns null (fixed-price, not auction)"
    - "Playwright E2E test verifies AMZD metadata extraction against a live Amazon liquidation page"
  artifacts:
    - path: "src/retailers/sites/amazon.ts"
      provides: "Working shipping_fee DOM selectors for Amazon liquidation pages"
    - path: "tests/e2e/amzd.pw.test.ts"
      provides: "E2E test for AMZD metadata extraction"
  key_links:
    - from: "src/retailers/sites/amazon.ts"
      to: "Amazon DOM"
      via: "extractShippingFee selectors"
      pattern: "shipping|delivery"
    - from: "tests/e2e/amzd.pw.test.ts"
      to: "src/retailers/sites/amazon.ts"
      via: "page.evaluate with same selector logic"
      pattern: "extractMetadata"
---

<objective>
Fix AMZD metadata extraction so shipping_fee returns correct values from Amazon liquidation pages, and create Playwright E2E tests to verify metadata extraction and CSV row count against a live AMZD listing.

Purpose: AMZD shipping_fee currently returns 0/null. The DOM selectors need updating for current Amazon page structure. E2E tests verify the fix works against real pages.
Output: Updated amazon.ts with working selectors, new amzd.pw.test.ts E2E test file.
</objective>

<execution_context>
@/home/sean/.claude/get-shit-done/workflows/execute-plan.md
@/home/sean/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-amzd-csv-metadata-fix-e2e/13-CONTEXT.md
@src/retailers/sites/amazon.ts
@tests/e2e/extension.setup.ts
@tests/e2e/bstock-nextjs.pw.test.ts (pattern reference)
@docs/RETAILER-SELECTORS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AMZD shipping_fee selectors and create E2E test</name>
  <files>src/retailers/sites/amazon.ts, tests/e2e/amzd.pw.test.ts</files>
  <action>
**Part A: Update shipping_fee selectors in `src/retailers/sites/amazon.ts`**

The current `extractShippingFee()` function has selectors that may not match current Amazon liquidation page structure. Update:

1. Navigate to a live Amazon liquidation page (e.g., search for Amazon liquidation lots on amazon.com/dp/) to understand current DOM structure
2. Amazon liquidation pages are product pages — shipping info appears in the delivery/shipping section
3. Key selectors to try (add to existing selector list if not present):
   - `#deliveryBlockMessage .a-text-bold` — delivery price in bold
   - `#mir-layout-DELIVERY_BLOCK-block` — full delivery block
   - `.a-section.a-spacing-none.a-padding-none span.a-text-bold` — shipping price
   - `#price-shipping-message` — direct shipping message
   - `span[data-csa-c-action="shipFromPrice"]` — Amazon analytics shipping price
4. The function already returns `0` for free shipping and `null` for not-found — this is correct
5. AMZD `bidPrice` correctly returns `null` (fixed-price) — no changes needed there

**Part B: Create Playwright E2E test `tests/e2e/amzd.pw.test.ts`**

Follow the pattern from `bstock-nextjs.pw.test.ts`:

1. Test URL: Use a current Amazon liquidation listing URL. Find one by searching amazon.com for liquidation pallets. These are amazon.com/dp/BXXXXXXXXXX URLs.
2. Test structure:
   - Launch browser with extension
   - Navigate to AMZD listing URL
   - Skip gracefully if page returns 404, login redirect, or "currently unavailable"
   - Use `page.evaluate()` to run the same selector logic as `extractMetadata` in amazon.ts
   - Assert: `bidPrice` is `null` (AMZD is fixed-price)
   - Assert: `shippingFee` is a number >= 0 (or null if shipping info not available — skip test gracefully)
   - Assert: `retailer` is detected as `'AMZD'`
   - Assert: listing name contains "Units"

3. Add a second test for row count verification (E2E-04):
   - This test verifies that the CSV blob capture produces the expected number of rows
   - Skip this test with a comment noting it requires the full extension pipeline and is deferred to manual verification
   - OR: Navigate to the page, check for "Download CSV" link presence, verify it exists

4. Tests must skip gracefully on:
   - Product unavailable / out of stock
   - Cloudflare challenge
   - Login redirect
   - 404

**Important:** AMZD is fixed-price. `bidPrice` must be `null`, not `0`. The decision [v1.1] states: "AMZD is fixed-price (bid_price returns null, not 0)".
  </action>
  <verify>
Run `npx playwright test tests/e2e/amzd.pw.test.ts --headed` — tests pass or skip gracefully.
Verify the shipping_fee selector returns a real value (not 0) on a live page by checking test output logs.
  </verify>
  <done>
AMZD extractMetadata returns correct shipping_fee from Amazon pages. bidPrice returns null (fixed-price). Playwright E2E test verifies extraction against live page. Tests skip gracefully on unavailable pages.
  </done>
</task>

</tasks>

<verification>
1. `npx playwright test tests/e2e/amzd.pw.test.ts` — passes or skips gracefully
2. Test output logs show shipping_fee as a real dollar amount (or null with graceful skip)
3. bidPrice confirmed as null in test output
4. No regression in other E2E tests: `npx playwright test`
</verification>

<success_criteria>
- AMZD shipping_fee extraction returns correct value from Amazon product page (SEL-19)
- AMZD bid_price correctly returns null for fixed-price listings (SEL-20)
- Playwright E2E test exists and verifies AMZD metadata (E2E-02, E2E-03 partial)
- E2E test for row count verification exists or is documented as manual (E2E-04)
</success_criteria>

<output>
After completion, create `.planning/phases/13-amzd-csv-metadata-fix-e2e/13-02-SUMMARY.md`
</output>
