---
phase: 13-amzd-csv-metadata-fix-e2e
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/raw-metadata.ts
  - src/parsers/csv-reader.ts
  - src/parsers/amzd-parser.ts
  - src/parsers/base-parser.ts
  - tests/parsers/amzd-parser.test.ts
autonomous: true

must_haves:
  truths:
    - "AMZD raw CSV download preserves all rows from source manifest — no truncation from embedded newlines"
    - "AMZD raw mode is byte-for-byte pass-through of manifest content, only appending 3 metadata columns"
    - "AMZD unified format correctly extracts qty/price from misaligned rows via right-anchor on full cells including __parsed_extra"
    - "Rows with unrecoverable misalignment are included with empty fields, never dropped"
  artifacts:
    - path: "src/utils/raw-metadata.ts"
      provides: "Line-level metadata column appending without full CSV re-parse"
    - path: "src/parsers/csv-reader.ts"
      provides: "readCsv returns rows with __parsed_extra merged into cells"
    - path: "src/parsers/base-parser.ts"
      provides: "parseAmzdManifest uses full cells including __parsed_extra"
  key_links:
    - from: "src/utils/raw-metadata.ts"
      to: "raw CSV output"
      via: "line-level append instead of parse-then-reserialize"
      pattern: "split lines, append columns"
    - from: "src/parsers/base-parser.ts"
      to: "src/parsers/amzd-parser.ts"
      via: "cells array includes __parsed_extra overflow"
      pattern: "__parsed_extra"
---

<objective>
Fix AMZD CSV parsing: (1) raw mode preserves all rows by appending metadata columns at the line level without re-parsing CSV content, and (2) unified mode correctly detects misaligned rows by including PapaParse `__parsed_extra` overflow in the cells array for right-anchor extraction.

Purpose: Raw CSV downloads currently lose rows due to embedded newlines being misinterpreted by the hand-rolled CSV parser, and unified mode misses misalignment because `Object.values(row)` excludes `__parsed_extra` fields.
Output: Fixed raw-metadata.ts (line-level append), fixed csv-reader.ts and base-parser.ts (__parsed_extra handling), updated tests.
</objective>

<execution_context>
@/home/sean/.claude/get-shit-done/workflows/execute-plan.md
@/home/sean/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-amzd-csv-metadata-fix-e2e/13-CONTEXT.md
@.planning/research/ARCHITECTURE.md (lines 240-299 — truncation point analysis)
@src/utils/raw-metadata.ts
@src/parsers/csv-reader.ts
@src/parsers/amzd-parser.ts
@src/parsers/base-parser.ts
@tests/parsers/amzd-parser.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix raw mode to append metadata at line level without re-parsing</name>
  <files>src/utils/raw-metadata.ts</files>
  <action>
Rewrite `appendMetadataToManifest()` for CSV files to use **line-level appending** instead of full CSV parse-and-reserialize. This preserves the original manifest content byte-for-byte (including embedded newlines in quoted fields, original quoting, original delimiters).

**Approach for CSV files:**
1. Decode base64 to string
2. Detect the delimiter from the first line (comma, tab, semicolon, pipe)
3. Split content into lines — but respect quoted fields containing newlines. Walk character-by-character: track `inQuotes` state. Only split on `\n` when NOT inside quotes.
4. For the header line (first line): append `{delimiter}auction_url{delimiter}bid_price{delimiter}shipping_fee`
5. For the first data line (second line): append `{delimiter}{auctionUrl}{delimiter}{bidPrice}{delimiter}{shippingFee}` — quote auctionUrl if it contains the delimiter
6. For all subsequent lines: append `{delimiter}{delimiter}{delimiter}` (3 empty columns)
7. Re-join lines with `\n` and prepend UTF-8 BOM

**For XLSX/XLS files:** Keep existing behavior (parse with xlsx library, re-serialize as CSV with metadata). Only CSVs get the line-level treatment.

**Key constraints from CONTEXT.md:**
- Failed metadata extraction uses `0` as the value (not empty, not null) — already handled by `?? 0`
- Metadata values are auction-level (same for every row) — only first data row gets values, rest empty
- Match source delimiter when appending columns

Log a `console.warn` when the quote-aware line splitter detects embedded newlines (a line break inside quotes).
  </action>
  <verify>
Existing tests in the test suite pass. Manually verify the logic handles:
- Standard CSV (no embedded newlines) — same row count out as in
- CSV with embedded newlines in quoted fields — rows preserved, not split
- Tab-delimited files — delimiter detected and used for appended columns
  </verify>
  <done>
Raw mode CSV output is byte-for-byte identical to source manifest content, with 3 metadata columns appended using the source delimiter. Embedded newlines in quoted fields do not cause row truncation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix unified mode __parsed_extra handling for AMZD misalignment detection</name>
  <files>src/parsers/csv-reader.ts, src/parsers/base-parser.ts, src/parsers/amzd-parser.ts, tests/parsers/amzd-parser.test.ts</files>
  <action>
Fix the `Object.values(row)` problem that excludes PapaParse `__parsed_extra` fields, causing misaligned AMZD rows to be undetected.

**In `src/parsers/base-parser.ts` — `parseAmzdManifest()`:**
1. When building the `cells` array, check if `row` has a `__parsed_extra` property (PapaParse adds this as an array when a row has more fields than headers)
2. If present, append `__parsed_extra` values to the cells array: `const cells = [...Object.values(row), ...((row as any).__parsed_extra || [])]`
3. This ensures `cells.length > headers.length` for misaligned rows, so `isAmzdMisaligned()` returns true and right-anchor extraction is used

**In `src/parsers/csv-reader.ts` — `readCsv()`:**
1. Do NOT filter out rows with `__parsed_extra` — they are valid data rows with extra commas in titles
2. Current PapaParse config logs FieldMismatch errors but continues — this is correct, keep it
3. No changes needed here unless the current `skipEmptyLines: true` or error handling drops rows. Verify it doesn't.

**In `src/parsers/amzd-parser.ts` — `parseAmzdRow()`:**
- No changes needed — it already handles misaligned rows correctly via right-anchor extraction once `cells.length > headers.length`
- Verify that when recovery fails (no ASIN, no productName, unitRetail=0), the row returns null. Per CONTEXT.md: "If recovery fails for a row, include the row with empty fields (don't drop rows)."
- Update: Change `parseAmzdRow` to return a row with empty/zero fields instead of null when recovery fails. Return null ONLY for truly empty rows (cells.length === 0).

**In `src/parsers/base-parser.ts` — `parseAmzdManifest()`:**
- After `parseAmzdRow` returns null for non-empty rows, create a fallback ManifestItem with empty fields instead of skipping: `{ upc: '', productName: 'Unknown Product', quantity: 1, unitRetail: 0, ... }`
- This ensures no rows are dropped even if parsing fails

**Tests (`tests/parsers/amzd-parser.test.ts`):**
- Add test: row with `__parsed_extra` — verify cells array includes overflow and `isAmzdMisaligned` returns true
- Add test: misaligned row where recovery fails — verify row is included with empty fields, not dropped
  </action>
  <verify>
Run `npx vitest run tests/parsers/amzd-parser.test.ts` — all tests pass including new ones.
Run `npx vitest run` — full test suite passes.
  </verify>
  <done>
Unified mode AMZD parsing includes `__parsed_extra` in cells array. Misaligned rows are correctly detected and use right-anchor extraction. Failed recovery produces a row with empty fields rather than dropping the row.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — all existing + new tests pass
2. Manual check: `parseAmzdRow` with a simulated misaligned row (more cells than headers) correctly uses right-anchor extraction
3. Manual check: `appendMetadataToManifest` with a CSV containing embedded newlines preserves all original lines
</verification>

<success_criteria>
- Raw mode AMZD CSV download preserves all rows from source manifest (CSV-01)
- AMZD columns do not bleed together in unified mode — __parsed_extra included in cells (CSV-02)
- Raw mode passes through manifest data without cleaning/sorting, only appending 3 metadata columns (CSV-03)
- No rows dropped due to recovery failure — included with empty fields instead
- All vitest tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-amzd-csv-metadata-fix-e2e/13-01-SUMMARY.md`
</output>
