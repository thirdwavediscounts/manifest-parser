---
phase: 07-file-naming-optimization
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/popup/popup.ts
autonomous: true

must_haves:
  truths:
    - "Filenames stay within ~50 character limit"
    - "Generated filenames use smart truncation instead of substring cut"
    - "Extension builds without errors"
  artifacts:
    - path: "src/popup/popup.ts"
      provides: "Updated generateListingFilename using filename-utils"
      contains: "smartTruncateTitle"
  key_links:
    - from: "src/popup/popup.ts"
      to: "src/utils/filename-utils.ts"
      via: "import statement"
      pattern: "import.*smartTruncateTitle.*filename-utils"
---

<objective>
Wire the new filename utility functions into the popup's generateListingFilename function.

Purpose: Replace the crude substring truncation with smart word-boundary-aware truncation that abbreviates common words.

Output:
- Updated `src/popup/popup.ts` with improved filename generation
- Working extension that produces readable filenames
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-file-naming-optimization/07-01-SUMMARY.md
@src/utils/filename-utils.ts
@src/popup/popup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update generateListingFilename to use smart truncation</name>
  <files>src/popup/popup.ts</files>
  <action>
    1. Add import at top of file:
       `import { smartTruncateTitle } from '../utils/filename-utils'`

    2. Update generateListingFilename function (around line 1275):
       - After sanitizing the listing name with the sanitize() function
       - Before the logic that extracts condition/time suffix
       - Apply smartTruncateTitle to the product part of the title

    Current flow:
    ```
    sanitizedListing = sanitize(listingName)
    // extract suffix logic
    // crude substring truncation
    ```

    New flow:
    ```
    sanitizedListing = sanitize(listingName)
    // extract suffix (condition + time) first - KEEP THIS LOGIC
    // Apply smart truncation to the product part ONLY
    productPart = smartTruncateTitle(productPart, maxProductLen)
    // recombine with suffix
    ```

    Key: The suffix extraction logic (lines 1296-1322) that preserves condition codes and time should remain. Only the product name truncation should use the new smart function.

    3. Remove the old substring truncation (lines 1327-1331):
       ```
       if (productPart.length > maxProductLen) {
         productPart = productPart.substring(0, maxProductLen)
         productPart = productPart.replace(/-$/, '')
       }
       ```
       Replace with:
       ```
       productPart = smartTruncateTitle(productPart, maxProductLen)
       ```
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    npm run build
    ```
  </verify>
  <done>
    - Import added for smartTruncateTitle
    - generateListingFilename uses smart truncation for product part
    - Suffix (condition + time) logic preserved
    - Build succeeds without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration test for filename generation</name>
  <files>tests/utils/filename-utils.test.ts</files>
  <action>
    Add a test case that validates the full flow similar to how popup.ts uses it:

    ```typescript
    describe('integration with popup filename pattern', () => {
      it('should handle listing name with condition and time suffix', () => {
        // Simulate popup flow: sanitize → extract suffix → truncate product
        const listingName = 'PC Gaming Accessories & Tablet Accessories-NEW-1430'
        const sanitized = listingName.replace(/\s+/g, '-')

        // Extract suffix (simplified version of popup logic)
        const parts = sanitized.split('-')
        const time = parts.pop() // '1430'
        const condition = parts.pop() // 'NEW'
        const productPart = parts.join('-')

        const truncated = smartTruncateTitle(productPart, 25)
        const result = `${truncated}-${condition}-${time}`

        expect(result.length).toBeLessThanOrEqual(35) // 25 + 10 for suffix
        expect(result).not.toMatch(/-$/) // No trailing dash
        expect(result).toContain('Acc') // Abbreviation applied
      })
    })
    ```
  </action>
  <verify>
    ```bash
    npx vitest run tests/utils/filename-utils.test.ts
    ```
  </verify>
  <done>
    - Integration test added and passes
    - Test validates end-to-end filename generation flow
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript check
npx tsc --noEmit

# All tests pass
npx vitest run

# Build extension
npm run build

# Manual verification: Load extension, process a URL, check generated filename
```
</verification>

<success_criteria>
- Build succeeds
- All tests pass (including new integration test)
- Generated filenames:
  - Stay within ~50 char limit
  - Never have partial words at end
  - Abbreviate common words like "Accessories" → "Acc"
  - Preserve condition codes and time suffixes
</success_criteria>

<output>
After completion, create `.planning/phases/07-file-naming-optimization/07-02-SUMMARY.md`
</output>
