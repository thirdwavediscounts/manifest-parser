---
phase: 08-metadata-dom-audit
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - tests/e2e/metadata-selectors.e2e.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "E2E tests validate full metadata flow: page load -> selectors -> parsed values"
    - "Tests run on-demand for manual verification before releases"
    - "Test failures log which selector broke for debugging"
    - "AMZD test expects bidPrice null (fixed-price) and handles free delivery"
  artifacts:
    - path: "tests/e2e/metadata-selectors.e2e.ts"
      provides: "Live E2E test suite for selector validation"
      contains: "extractBidPrice.*extractShippingFee"
  key_links:
    - from: "tests/e2e/metadata-selectors.e2e.ts"
      to: "src/retailers/sites/*.ts"
      via: "Imports extractMetadata functions"
      pattern: "from.*retailers/sites"
---

<objective>
Create E2E test infrastructure to validate bid/shipping selectors against live retailer pages.

Purpose: Enable on-demand verification that selectors still work when retailer sites may have changed. Tests validate the full metadata extraction pipeline.

Output: E2E test file that can be run manually to verify selector health, with clear failure logging.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-metadata-dom-audit/08-CONTEXT.md
@.planning/phases/08-metadata-dom-audit/08-01-PLAN.md
@docs/SELECTORS.md
@src/retailers/types.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E test file for metadata selector validation</name>
  <files>tests/e2e/metadata-selectors.e2e.ts</files>
  <action>
Create tests/e2e/metadata-selectors.e2e.ts with the following structure:

1. **File header comment** explaining:
   - Purpose: On-demand E2E tests for validating metadata selectors
   - When to run: Manually when investigating issues or before releases
   - Not part of CI - requires live retailer pages

2. **Test setup** using jsdom or similar to simulate DOM:
   - Since this is a Chrome extension, we can't run against live pages directly
   - Instead, create snapshot-based tests that validate selector logic
   - Store HTML snapshots in tests/fixtures/retailer-pages/

3. **Test structure** for EACH retailer (11 total):
   ```typescript
   describe('Metadata Selector Validation', () => {
     describe('B-Stock Auction Pages', () => {
       describe('ACE', () => {
         it('should extract bid price from ACE auction page', () => {
           // Load snapshot HTML
           // Call extractBidPrice equivalent function
           // Verify result is number or null (not undefined)
           // Log selector used on success/failure
         });

         it('should extract shipping fee from ACE auction page', () => {
           // Similar pattern
         });
       });
       // ... BY, JCP, QVC
     });

     describe('TechLiquidators', () => {
       describe('TL', () => {
         it('should extract bid price from TL detail page', () => { ... });
         it('should extract shipping fee from TL detail page', () => { ... });
       });
     });

     describe('Amazon Direct', () => {
       describe('AMZD', () => {
         it('should return null for bid price (fixed-price listing)', () => {
           // AMZD is fixed-price, bidPrice should always be null
         });
         it('should extract shipping fee or detect free delivery', () => {
           // Check for 0 (free) or number
         });
       });
     });

     describe('B-Stock Marketplace', () => {
       // AMZ, ATT, COSTCO, TGT, RC
     });
   });
   ```

4. **Helper functions**:
   - `loadPageSnapshot(retailer: string): Document` - loads HTML fixture
   - `logSelectorResult(retailer: string, field: string, value: number | null, selector: string)` - logs extraction result
   - `validateBidPrice(doc: Document, extractFn: () => number | null, retailer: string)` - wrapper with logging
   - `validateShippingFee(doc: Document, extractFn: () => number | null, retailer: string)` - wrapper with logging

5. **Failure logging**:
   - On failure: log "SELECTOR FAILED: [retailer] [field] - selector '[selector]' found no match"
   - Include which file contains the selector for quick navigation

6. **Mock fixtures**:
   - Create minimal HTML fixtures in tests/fixtures/retailer-pages/ that contain:
     - Sample bid price elements with realistic values
     - Sample shipping fee elements
   - Fixtures should be small (just relevant DOM structure, not full pages)

Note: These are snapshot tests, not live tests. The purpose is to verify selector logic against known HTML structures. When retailer sites change, update the fixtures and selectors together.
  </action>
  <verify>
- tests/e2e/metadata-selectors.e2e.ts exists
- File contains test cases for all 11 retailers
- grep -c "describe\|it\(" tests/e2e/metadata-selectors.e2e.ts returns > 30 (tests + describes)
- File imports from retailer modules or reimplements selector logic
  </verify>
  <done>
E2E test file exists with test cases for all 11 retailers covering bid price and shipping fee extraction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HTML fixture files and verify tests pass</name>
  <files>tests/fixtures/retailer-pages/*.html, package.json</files>
  <action>
1. Create fixture directory: tests/fixtures/retailer-pages/

2. Create minimal HTML fixtures for each retailer type:
   - bstock-auction.html (covers ACE, BY, JCP, QVC)
   - techliquidators.html (covers TL)
   - amazon-direct.html (covers AMZD)
   - bstock-marketplace.html (covers AMZ, ATT, COSTCO, TGT, RC)

Each fixture should contain:
```html
<!DOCTYPE html>
<html>
<head><title>[Retailer] Test Page</title></head>
<body>
  <!-- Bid price element -->
  <div class="bid-amount">$1,234.56</div>

  <!-- Shipping element -->
  <div class="shipping">Shipping: $150.00</div>

  <!-- Alternative patterns for fallback testing -->
  <p>Current Bid: $1,234.56</p>
  <p>Free Shipping</p>
</body>
</html>
```

3. Update package.json to add test script for E2E tests (if not exists):
   ```json
   "scripts": {
     "test:e2e": "jest tests/e2e --testTimeout=30000"
   }
   ```

4. Run tests to verify they pass:
   - npm run test:e2e
   - All selector tests should pass against fixtures

5. If using jsdom, ensure it's installed:
   - Check if jsdom is in devDependencies
   - If not, note that jest already includes jsdom testEnvironment
  </action>
  <verify>
- tests/fixtures/retailer-pages/ directory exists with HTML files
- npm run test:e2e passes (or equivalent jest command)
- Each fixture file contains bid and shipping elements
- Tests detect selector matches correctly
  </verify>
  <done>
HTML fixtures exist for all retailer types, and E2E tests pass against the fixtures.
  </done>
</task>

</tasks>

<verification>
1. E2E test infrastructure complete:
   - tests/e2e/metadata-selectors.e2e.ts exists
   - Covers all 11 retailers
   - Tests both bid price and shipping fee

2. Fixtures exist:
   - tests/fixtures/retailer-pages/ contains HTML files
   - Fixtures have representative DOM structure

3. Tests pass:
   - npm run test:e2e (or jest tests/e2e) succeeds
   - No selector failures against fixtures

4. Failure logging works:
   - Intentionally break a selector to verify logging
   - Message format: "SELECTOR FAILED: [retailer] [field] - ..."
</verification>

<success_criteria>
- E2E test file exists with 11+ retailer test sections
- HTML fixtures exist for all retailer page types
- Tests pass when run against fixtures
- AMZD tests correctly expect null bid price
- Test failure logs identify which selector failed
- Package.json has test:e2e script (or tests work with existing test command)
</success_criteria>

<output>
After completion, create `.planning/phases/08-metadata-dom-audit/08-02-SUMMARY.md`
</output>
