---
phase: 06-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/popup/index.html
  - src/popup/popup.css
  - src/popup/popup.ts
autonomous: true

must_haves:
  truths:
    - "Toggle switch visible at top of popup near title"
    - "Toggle shows 'Raw' and 'Unified' labels"
    - "Toggle state persists when popup closes and reopens"
    - "Default state is Raw for first-time users"
    - "Raw mode downloads original CSV/XLSX files"
    - "Unified mode downloads processed unified CSV format"
  artifacts:
    - path: "src/popup/index.html"
      provides: "Toggle switch HTML element"
      contains: "format-toggle"
    - path: "src/popup/popup.css"
      provides: "Toggle switch styling"
      contains: "toggle-switch"
    - path: "src/popup/popup.ts"
      provides: "Toggle state persistence and processing branch"
      contains: "formatMode"
  key_links:
    - from: "src/popup/popup.ts"
      to: "chrome.storage.local"
      via: "formatMode persistence"
      pattern: "storage\\.local\\.set.*formatMode"
    - from: "src/popup/popup.ts"
      to: "handleProcess"
      via: "formatMode branch for raw vs unified"
      pattern: "state\\.formatMode.*raw"
---

<objective>
Add format toggle to popup UI enabling users to choose between raw file downloads and unified format.

Purpose: Complete the UI Integration phase by giving users control over output format while preserving the default behavior (raw files) for backward compatibility.
Output: Toggle switch in popup, state persistence, processing path that branches based on toggle.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ui-integration/06-CONTEXT.md

@src/popup/popup.ts
@src/popup/index.html
@src/popup/popup.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add toggle UI and persistence</name>
  <files>src/popup/index.html, src/popup/popup.css, src/popup/popup.ts</files>
  <action>
1. In index.html, add toggle switch inside header element after subtitle:
   - Container div with class "format-toggle-container"
   - Two span labels: "Raw" and "Unified"
   - Toggle switch input (checkbox styled as switch) with id "format-toggle"
   - Position: inline-flex, centered in header

2. In popup.css, add toggle switch styles:
   - .format-toggle-container: flex layout, centered, gap between elements
   - .toggle-switch: custom checkbox styled as sliding toggle (40px wide, 20px tall)
   - .toggle-switch::before: slider circle (16px)
   - .toggle-switch:checked: slide right, change background color
   - .toggle-label: small text (11px), white/semi-transparent for header
   - .toggle-label.active: full opacity when that option is selected

3. In popup.ts:
   - Add formatMode to PopupState interface: formatMode: 'raw' | 'unified'
   - Initialize state.formatMode to 'raw' (default)
   - Add formatToggle to elements object
   - In saveState(): include formatMode in persistableState
   - In loadState(): restore formatMode from storage (default 'raw' if missing)
   - In init(): restore toggle checked state from state.formatMode
   - Add setupEventListeners(): toggle change handler that:
     - Updates state.formatMode based on checked (checked = 'unified', unchecked = 'raw')
     - Updates visual active states on labels
     - Calls saveState()
  </action>
  <verify>
1. npx tsc --noEmit passes
2. Grep for "format-toggle" in index.html
3. Grep for "toggle-switch" in popup.css
4. Grep for "formatMode" in popup.ts
  </verify>
  <done>
- Toggle switch appears in header between subtitle and main content
- Labels show "Raw" (left) and "Unified" (right)
- Toggle defaults to unchecked (Raw mode)
- Toggle state saves when changed and restores when popup reopens
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire toggle to processing path</name>
  <files>src/popup/popup.ts</files>
  <action>
Modify handleProcess() to branch based on state.formatMode:

1. For UNIFIED mode (current behavior):
   - Keep existing code: parse manifest, transform to unified format, generate unified CSV
   - Use transformToUnified() and generateUnifiedCsv()
   - Create ZIP from unifiedEntries

2. For RAW mode (new branch):
   - Skip transformation step
   - Collect raw file data directly (base64 + filename + type)
   - Create new type RawZipEntry: { filename: string, data: string, type: 'csv' | 'xlsx' | 'xls' }
   - Add createZipFromRawFiles() in zip-export.ts that:
     - Decodes base64 to binary
     - Adds file to ZIP with original extension
   - Use createZipFromRawFiles() instead of createZipFromUnifiedManifests()

3. Update progress text:
   - Keep generic "Processing..." (per CONTEXT.md: no format mention during processing)

4. Filename handling:
   - Per CONTEXT.md: filename does NOT change based on format
   - Use same generateListingFilename() for both modes
   - Raw mode preserves original file extension (.xlsx, .csv)

5. Error handling:
   - Per CONTEXT.md: if unified processing fails, show error only, no fallback
   - Add try/catch around transformation, throw error with message
  </action>
  <verify>
1. npx tsc --noEmit passes
2. Grep for "state.formatMode" in popup.ts
3. Grep for "createZipFromRawFiles" in zip-export.ts
4. Grep for "'raw'" in popup.ts (checking branch logic)
  </verify>
  <done>
- Raw mode downloads original CSV/XLSX files as-is (no transformation)
- Unified mode downloads processed CSV with unified columns (existing behavior)
- Both modes create ZIP with appropriate content
- Error in unified mode shows error message (no automatic fallback)
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. TypeScript compiles: `npx tsc --noEmit`
2. Toggle visible in popup header
3. Toggle persists across popup close/open
4. Raw mode produces ZIP with original file formats
5. Unified mode produces ZIP with unified CSV format
</verification>

<success_criteria>
- [ ] Toggle switch visible at top of popup, labeled "Raw" / "Unified"
- [ ] First-time users see Raw selected (default)
- [ ] Toggle state persists in chrome.storage.local
- [ ] Raw mode: original CSV/XLSX files in ZIP
- [ ] Unified mode: processed unified CSV files in ZIP
- [ ] TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-ui-integration/06-01-SUMMARY.md`
</output>
