---
phase: 04-data-processing-pipeline
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/unified/processing.ts
  - tests/unified/processing.test.ts
autonomous: true

must_haves:
  truths:
    - "Whitespace is trimmed from all string fields"
    - "Non-printable characters are removed from fields"
    - "item_number has all internal whitespace stripped"
    - "Rows with same normalized item_number are merged"
    - "Merged rows have summed quantities"
    - "Merged rows use product_name from highest-quantity row"
    - "Merged rows use highest unit_retail value"
    - "Merged rows preserve longer item_number format"
    - "Rows with empty item_number are never merged"
  artifacts:
    - path: "src/unified/processing.ts"
      provides: "Data cleaning and deduplication functions"
      exports: ["cleanField", "cleanRow", "normalizeItemNumber", "deduplicateRows"]
    - path: "tests/unified/processing.test.ts"
      provides: "TDD test coverage for processing functions"
      min_lines: 150
  key_links:
    - from: "deduplicateRows"
      to: "normalizeItemNumber"
      via: "normalization for duplicate detection"
      pattern: "normalizeItemNumber.*item_number"
---

<objective>
Implement data cleaning and deduplication functions for manifest rows.

Purpose: Clean inconsistent data (whitespace, non-printable chars) and merge duplicate items to produce accurate inventory counts and cleaner output.

Output: `src/unified/processing.ts` with cleaning and deduplication functions, fully tested via TDD.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-processing-pipeline/04-CONTEXT.md
@src/unified/types.ts
@src/unified/transform.ts
</context>

<feature>
  <name>Data Cleaning and Deduplication</name>
  <files>src/unified/processing.ts, tests/unified/processing.test.ts</files>
  <behavior>
    **Cleaning:**
    - cleanField(value: string): string
      - Input: "  hello world  " → Output: "hello world"
      - Input: "text\u0000\u200Bhere" → Output: "texthere" (strips non-printable + zero-width)
      - Input: "" → Output: ""

    - cleanRow(row: UnifiedManifestRow): UnifiedManifestRow
      - Applies cleanField to all string fields
      - item_number additionally strips ALL whitespace: "ABC 123" → "ABC123"
      - qty and unit_retail unchanged (numbers)

    **Normalization (for comparison only):**
    - normalizeItemNumber(value: string): string
      - Lowercase: "ABC123" → "abc123"
      - Strip leading zeros: "00123" → "123"
      - Already stripped whitespace from cleanRow

    **Deduplication:**
    - deduplicateRows(rows: UnifiedManifestRow[]): UnifiedManifestRow[]
      - Group by normalizeItemNumber(item_number)
      - Rows with empty item_number: keep as-is, never merge
      - Merge logic per group:
        - qty = SUM of all quantities
        - product_name = from row with HIGHEST qty (tiebreaker: first seen)
        - unit_retail = HIGHEST value across all rows
        - item_number = LONGEST format (preserves leading zeros)
        - auction_url, bid_price, shipping_fee = from first row in group

    **Test cases:**
    - Clean: whitespace trim, non-printable strip, empty string
    - Clean row: item_number whitespace fully stripped
    - Normalize: lowercase, leading zeros
    - Dedup: no duplicates returns same rows
    - Dedup: two rows same item → merged with summed qty
    - Dedup: three rows → correct merge (qty from highest, price highest)
    - Dedup: leading zeros preserved ("00123" kept over "123")
    - Dedup: case-insensitive ("ABC" and "abc" merged)
    - Dedup: empty item_number rows kept separate
    - Dedup: tiebreaker uses first seen row
  </behavior>
  <implementation>
    1. Create src/unified/processing.ts with function stubs
    2. Implement cleanField: trim + regex to remove non-printable characters
       - Non-printable: control chars (0x00-0x1F, 0x7F), zero-width chars (\u200B, \uFEFF, etc.)
    3. Implement cleanRow: apply cleanField, special handling for item_number
    4. Implement normalizeItemNumber: lowercase, strip leading zeros with regex
    5. Implement deduplicateRows:
       - Filter out empty item_number rows, process them separately
       - Use Map<normalizedKey, row[]> to group
       - For each group, compute merged row
       - Return merged rows + original empty-item_number rows
    6. Export all functions from src/unified/index.ts
  </implementation>
</feature>

<verification>
```bash
# Run tests in watch mode during TDD
npm test -- --grep "processing"

# Final verification
npm test
npx tsc --noEmit
```
</verification>

<success_criteria>
- [ ] All processing tests pass (RED → GREEN → REFACTOR complete)
- [ ] cleanField trims whitespace and removes non-printable characters
- [ ] cleanRow applies cleaning to all fields, strips all whitespace from item_number
- [ ] normalizeItemNumber handles case and leading zeros correctly
- [ ] deduplicateRows merges correctly following all merge rules from CONTEXT.md
- [ ] Empty item_number rows are never merged
- [ ] TypeScript compiles without errors
- [ ] Functions exported from src/unified/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-processing-pipeline/04-01-SUMMARY.md`
</output>
