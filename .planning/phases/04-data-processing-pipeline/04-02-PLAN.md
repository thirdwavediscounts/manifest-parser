---
phase: 04-data-processing-pipeline
plan: 02
type: tdd
wave: 2
depends_on: [04-01]
files_modified:
  - src/unified/processing.ts
  - src/unified/transform.ts
  - src/unified/index.ts
  - tests/unified/processing.test.ts
autonomous: true

must_haves:
  truths:
    - "Output is sorted by unit_retail descending (highest first)"
    - "Items with equal unit_retail are sorted by product_name alphabetically"
    - "Sorting is case-insensitive for product_name"
    - "Rows with empty unit_retail appear at the end"
    - "Processing pipeline applies: clean → deduplicate → sort"
    - "transformToUnified produces processed output by default"
  artifacts:
    - path: "src/unified/processing.ts"
      provides: "Sorting and pipeline functions"
      exports: ["sortRows", "processRows"]
    - path: "src/unified/transform.ts"
      provides: "Updated transformation with processing"
      contains: "processRows"
    - path: "tests/unified/processing.test.ts"
      provides: "Sorting and integration test coverage"
      min_lines: 250
  key_links:
    - from: "src/unified/transform.ts"
      to: "processRows"
      via: "import and call in transformToUnified"
      pattern: "processRows.*rows"
---

<objective>
Implement row sorting and integrate full processing pipeline into transformation.

Purpose: Sort manifest output by value (highest unit_retail first) for quick analysis and integrate cleaning, deduplication, and sorting into the main transformation flow.

Output: Complete processing pipeline integrated into `transformToUnified`, fully tested.
</objective>

<execution_context>
@C:\Users\Shealtiel\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Shealtiel\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-processing-pipeline/04-CONTEXT.md
@.planning/phases/04-data-processing-pipeline/04-01-SUMMARY.md
@src/unified/types.ts
@src/unified/transform.ts
@src/unified/processing.ts
</context>

<feature>
  <name>Sorting and Pipeline Integration</name>
  <files>src/unified/processing.ts, src/unified/transform.ts, tests/unified/processing.test.ts</files>
  <behavior>
    **Sorting:**
    - sortRows(rows: UnifiedManifestRow[]): UnifiedManifestRow[]
      - Primary: unit_retail DESCENDING (999 before 100)
      - Secondary: product_name ALPHABETICAL, case-insensitive (Apple before Banana)
      - Rows with unit_retail = 0 or empty: placed at END
      - Stable sort: preserve relative order for equal keys

    **Sort test cases:**
    - Input: [{retail: 50}, {retail: 100}] → Output: [{retail: 100}, {retail: 50}]
    - Input: [{retail: 100, name: "Banana"}, {retail: 100, name: "Apple"}] → Output: Apple first
    - Input: [{retail: 0}, {retail: 50}] → Output: [{retail: 50}, {retail: 0}]
    - Case-insensitive: "apple" and "Apple" sort together

    **Pipeline:**
    - processRows(rows: UnifiedManifestRow[]): UnifiedManifestRow[]
      - Applies: cleanRow to each → deduplicateRows → sortRows
      - Single function that chains all processing

    **Integration:**
    - transformToUnified calls processRows before returning
    - Metadata assignment happens AFTER processing (first sorted row gets metadata)
    - Note: This changes behavior - metadata now goes to highest-value item

    **Important consideration:**
    - Current behavior: metadata on first row of input
    - New behavior: metadata on first row of PROCESSED output (highest value item)
    - This is correct per requirements: after sorting, row 1 is highest value

    **Integration test cases:**
    - End-to-end: dirty data → clean, deduplicated, sorted output
    - Verify metadata appears on first row (which is now highest-value item)
  </behavior>
  <implementation>
    1. Add sortRows function to processing.ts:
       - Use Array.sort() with comparator
       - Handle 0/empty unit_retail as "sort last" (treat as -Infinity for comparison)
       - Case-insensitive product_name comparison with localeCompare

    2. Add processRows pipeline function:
       - rows.map(cleanRow) → deduplicateRows → sortRows
       - Single composition for clean API

    3. Modify transformToUnified in transform.ts:
       - Import processRows from './processing'
       - Apply processRows to items BEFORE mapping to rows
       - Wait - items are ManifestItem[], not UnifiedManifestRow[]
       - Processing should happen AFTER initial mapping, BEFORE metadata assignment

    4. Restructure transformToUnified:
       ```typescript
       export function transformToUnified(items, metadata) {
         // First, map to basic rows (no metadata yet)
         const basicRows = items.map(item => ({
           item_number: item.upc,
           product_name: item.productName,
           qty: Math.round(item.quantity),
           unit_retail: item.unitRetail,
           auction_url: '',
           bid_price: '',
           shipping_fee: '',
         }))

         // Process: clean, deduplicate, sort
         const processedRows = processRows(basicRows)

         // Add metadata to first processed row
         if (processedRows.length > 0) {
           processedRows[0] = {
             ...processedRows[0],
             auction_url: metadata.auctionUrl,
             bid_price: metadata.bidPrice !== null ? formatPrice(metadata.bidPrice) : '',
             shipping_fee: metadata.shippingFee !== null ? formatPrice(metadata.shippingFee) : '',
           }
         }

         return processedRows
       }
       ```

    5. Update exports in index.ts

    6. Update existing transform tests to expect sorted output
  </implementation>
</feature>

<verification>
```bash
# Run processing tests
npm test -- --grep "processing"

# Run transform tests (may need updates for new sorted behavior)
npm test -- --grep "transform"

# Full test suite
npm test

# Type check
npx tsc --noEmit

# Build extension
npm run build
```
</verification>

<success_criteria>
- [ ] sortRows correctly orders by unit_retail DESC, product_name ASC
- [ ] Rows with 0/empty unit_retail appear at end
- [ ] Case-insensitive product_name sorting works
- [ ] processRows chains clean → deduplicate → sort
- [ ] transformToUnified uses processRows internally
- [ ] Metadata appears on first row of sorted output (highest-value item)
- [ ] All existing tests pass (updated for new behavior)
- [ ] All new processing tests pass
- [ ] TypeScript compiles without errors
- [ ] Extension builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-processing-pipeline/04-02-SUMMARY.md`
</output>
