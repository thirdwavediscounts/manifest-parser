---
phase: 10-playwright-e2e-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - playwright.config.ts
  - tests/e2e/extension.setup.ts
  - tests/e2e/smoke-tl.test.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "Playwright launches Chromium with the built extension loaded via persistent context"
    - "A test can navigate to a live TL auction URL and see auction page content"
    - "A test can open the extension popup and interact with it"
    - "TL metadata extraction (bid_price + shipping_fee) returns non-zero values via E2E"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright config for Chrome extension testing"
      contains: "use.*channel.*chromium"
    - path: "tests/e2e/extension.setup.ts"
      provides: "Shared helpers: launch browser with extension, open popup, extract metadata"
      exports: ["launchBrowserWithExtension", "getExtensionId", "openPopup"]
    - path: "tests/e2e/smoke-tl.test.ts"
      provides: "TL smoke test proving infrastructure works end-to-end"
      contains: "expect.*bid"
  key_links:
    - from: "playwright.config.ts"
      to: "tests/e2e/*.test.ts"
      via: "testDir and project config"
    - from: "tests/e2e/extension.setup.ts"
      to: "dist/"
      via: "persistent context loads built extension from dist/"
    - from: "tests/e2e/smoke-tl.test.ts"
      to: "tests/e2e/extension.setup.ts"
      via: "imports shared helpers"
---

<objective>
Set up Playwright E2E test infrastructure for Chrome extension testing, validated by a TL smoke test.

Purpose: All subsequent phases (11, 12, 13) need E2E tests against live auction pages. This phase creates the reusable infrastructure: launching Chromium with the extension loaded, navigating to auction pages, triggering metadata extraction, and verifying results.

Output: Playwright config, shared extension helpers, and a passing TL smoke test.
</objective>

<execution_context>
@/home/sean/.claude/get-shit-done/workflows/execute-plan.md
@/home/sean/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Extension structure
@manifest.json (root — used by vite/crx build)
@vite.config.ts
@src/retailers/sites/techliquidators.ts

# Existing E2E tests (jsdom-based, NOT Playwright — this is what we're replacing for live pages)
@tests/e2e/metadata-selectors.test.ts (first 30 lines for pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and create config + extension helpers</name>
  <files>
    package.json
    playwright.config.ts
    tests/e2e/extension.setup.ts
  </files>
  <action>
1. Install Playwright and Chromium browser:
   ```
   npm install -D @playwright/test
   npx playwright install chromium
   ```

2. Add npm script to package.json:
   ```json
   "test:e2e:pw": "npx playwright test"
   ```

3. Create `playwright.config.ts`:
   - testDir: `./tests/e2e`
   - testMatch: `**/*.pw.test.ts` (use `.pw.test.ts` suffix to distinguish from existing vitest e2e tests)
   - timeout: 60000 (live pages can be slow)
   - No webServer needed (testing against live sites)
   - Single project: chromium only
   - retries: 1 (network flakiness)

4. Create `tests/e2e/extension.setup.ts` with shared helpers:

   **`launchBrowserWithExtension()`**:
   - Uses `chromium.launchPersistentContext()` with a temp dir as userDataDir
   - Args: `--disable-extensions-except=./dist`, `--load-extension=./dist`
   - headless: false (extensions require headed mode — use `--headed` or `chromium.launchPersistentContext` which is always headed)
   - Returns the BrowserContext

   **`getExtensionId(context)`**:
   - Gets service worker from `context.serviceWorkers()` or waits with `context.waitForEvent('serviceworker')`
   - Extracts extension ID from service worker URL: `sw.url().split('/')[2]`
   - Returns the extension ID string

   **`openPopup(context, extensionId)`**:
   - Navigates a new page to `chrome-extension://${extensionId}/src/popup/index.html`
   - Returns the popup Page

   **`extractMetadataFromPage(context, url)`**:
   - Creates a new page, navigates to the auction URL
   - Uses `page.evaluate()` to run the content script's `extractMetadata()` logic
   - OR: Uses `chrome.scripting.executeScript` via the extension's background
   - Simpler approach: Navigate to URL, then use popup's "process single URL" flow
   - Returns { bidPrice, shippingFee } or null

   NOTE on extractMetadata approach: The extension uses content scripts with ISOLATED world. For E2E, the simplest approach is:
   a. Navigate to auction URL in a tab
   b. Open popup page
   c. Trigger processing via popup UI (paste URL, click process)
   d. Read results from popup DOM

   This tests the REAL user flow. Start with this approach.

  </action>
  <verify>
   - `npx playwright --version` outputs version
   - `playwright.config.ts` exists and is valid TypeScript
   - `tests/e2e/extension.setup.ts` exports helper functions
   - `npm run build` succeeds (extension builds to dist/)
  </verify>
  <done>
   Playwright installed with Chromium. Config file points to e2e test dir. Extension helper module exports launchBrowserWithExtension, getExtensionId, and openPopup functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TL smoke test proving full E2E flow</name>
  <files>
    tests/e2e/smoke-tl.pw.test.ts
  </files>
  <action>
Create `tests/e2e/smoke-tl.pw.test.ts` that proves the infrastructure works end-to-end:

1. Use `test.describe('TL Smoke Test')` with Playwright's test runner (import from `@playwright/test`)

2. In `test.beforeAll`:
   - Run `npm run build` via exec/child_process to ensure fresh dist/
   - Call `launchBrowserWithExtension()` to get context
   - Call `getExtensionId(context)` to get extension ID

3. In `test.afterAll`:
   - Close the browser context

4. Test: "extension loads and popup opens":
   - Call `openPopup(context, extensionId)`
   - Assert popup page title or a known DOM element exists (e.g., the format toggle, process button)

5. Test: "TL auction page loads metadata":
   - Find a live TL auction URL. Use: `https://www.techliquidators.com/auctions/XXXXX` — check docs/SELECTORS.md or docs/RETAILER-SELECTORS.md for a sample URL
   - Navigate to the TL URL in a new page
   - Wait for page to load
   - Use `page.evaluate()` to extract bid price and shipping fee using the same selectors from `src/retailers/sites/techliquidators.ts`:
     - bid_price: `document.querySelector('.current_bid .amount')?.textContent`
     - shipping_fee: `document.querySelector('#shipping_fee')?.textContent`
   - Assert bidPrice is a string containing a dollar amount (not null, not "0")
   - Assert shippingFee is a string containing a dollar amount (not null, not "0")
   - Log actual values for debugging

   NOTE: If TL auction URLs are expired/unavailable, the test should skip gracefully with `test.skip()` and a message. Check the page title or a known element to detect if the auction is still live.

6. Use `.pw.test.ts` suffix so Playwright picks it up but vitest ignores it.

  </action>
  <verify>
   Run: `npx playwright test tests/e2e/smoke-tl.pw.test.ts --headed`
   - Browser launches with extension loaded
   - Popup opens successfully
   - TL metadata test either passes (with real values) or skips (auction expired)
   - No crashes or unhandled errors
  </verify>
  <done>
   TL smoke test passes: extension loads in Chromium, popup opens, and TL metadata extraction returns non-zero bid_price and shipping_fee from a live auction page. Infrastructure is validated for use by phases 11-13.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Playwright E2E infrastructure with TL smoke test. Extension loads in Chromium, popup accessible, metadata extraction works against live TL page.</what-built>
  <how-to-verify>
    1. Run: `npx playwright test --headed` from project root
    2. Observe: Chromium launches with extension icon visible
    3. Observe: Tests run — popup opens, TL page loads, metadata extracted
    4. Check: Test output shows bid_price and shipping_fee values from live TL page
    5. If TL auction is expired, test should skip gracefully (not fail)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx playwright test --headed` runs without errors
2. Extension loads in Chromium browser (visible in toolbar)
3. Popup page accessible at `chrome-extension://ID/src/popup/index.html`
4. TL smoke test extracts real metadata values (or skips gracefully if auction expired)
5. Existing vitest tests still pass: `npm test`
</verification>

<success_criteria>
- Playwright installed and configured for Chrome extension E2E testing
- Shared helpers (launchBrowserWithExtension, getExtensionId, openPopup) work correctly
- TL smoke test validates the full infrastructure by extracting live metadata
- Phases 11, 12, 13 can import the helpers and write their own retailer-specific tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-playwright-e2e-infrastructure/10-01-SUMMARY.md`
</output>
